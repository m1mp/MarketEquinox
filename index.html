<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Vape Market Ultimate</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      /* Deep Space Theme */
      --bg-color: #020617;
      --card-bg: rgba(30, 41, 59, 0.6);
      --card-border: 1px solid rgba(255, 255, 255, 0.08);
      
      /* Neons */
      --primary: #10b981;    /* Emerald */
      --primary-dark: #059669;
      --accent: #6366f1;     /* Indigo */
      --danger: #ef4444;
      
      --text-main: #f8fafc;
      --text-sec: #94a3b8;
      
      --shadow-glow: 0 0 20px rgba(16, 185, 129, 0.15);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    body {
      margin: 0;
      padding: 0;
      /* Animated Deep Gradient */
      background: linear-gradient(-45deg, #020617, #0f172a, #1e1b4b, #0f172a);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: 100px;
      overflow-x: hidden;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* SCROLLBAR HIDING */
    ::-webkit-scrollbar { width: 0; background: transparent; }

    /* LAYOUT */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      position: relative;
      z-index: 1;
    }

    .hidden { display: none !important; }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0 20px 0;
    }
    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-icon {
      font-size: 24px;
      animation: floatIcon 3s ease-in-out infinite;
    }
    @keyframes floatIcon {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .logo-text {
      font-size: 22px;
      font-weight: 800;
      background: linear-gradient(to right, #fff, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    /* SEARCH */
    .search-wrapper {
      position: relative;
      margin-bottom: 16px;
    }
    .search-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: var(--card-border);
      border-radius: 16px;
      padding: 12px 12px 12px 42px;
      color: #fff;
      font-size: 15px;
      transition: all 0.3s;
    }
    .search-input:focus {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }
    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
    }

    /* CATEGORIES */
    .cats-row {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 5px;
      margin-bottom: 16px;
    }
    .cat-chip {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 18px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .cat-chip.active {
      background: var(--primary);
      color: #000;
      font-weight: 700;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      transform: scale(1.05);
    }

    /* PRODUCTS GRID */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* PRODUCT CARD - STAGGER ANIMATION */
    .card {
      background: var(--card-bg);
      border: var(--card-border);
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
      /* Stagger setup */
      opacity: 0;
      animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    
    @keyframes slideUpFade {
      from { transform: translateY(30px) scale(0.95); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .card-image-box {
      width: 100%;
      padding-top: 100%; /* Square */
      position: relative;
      background: #1e293b;
      overflow: hidden;
    }
    .card-img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    .card:active .card-img {
      transform: scale(1.1); /* Zoom on tap */
    }

    .fav-btn {
      position: absolute;
      top: 8px; right: 8px;
      width: 28px; height: 28px;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      color: #fff;
      border: none;
      cursor: pointer;
      z-index: 2;
      transition: transform 0.2s;
    }
    .fav-btn:active { transform: scale(0.8); }
    .fav-btn.active { color: #ef4444; background: rgba(255,255,255,0.9); }

    .card-content {
      padding: 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.3;
      margin-bottom: 4px;
      flex: 1;
    }
    .card-sub {
      font-size: 11px;
      color: var(--text-sec);
      margin-bottom: 10px;
    }
    
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }
    .price {
      font-size: 15px;
      font-weight: 700;
      color: var(--primary);
    }

    /* DYNAMIC BUTTONS */
    .action-btn {
      height: 34px;
      padding: 0 14px;
      border-radius: 12px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      gap: 6px;
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    /* Green Add Button */
    .btn-add {
      background: rgba(16, 185, 129, 0.15);
      color: var(--primary);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .btn-add:active {
      transform: scale(0.92);
      background: var(--primary);
      color: #000;
    }
    
    /* Blue Choose Button */
    .btn-choose {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
      border: 1px solid rgba(99, 102, 241, 0.3);
    }
    .btn-choose:active {
      transform: scale(0.92);
      background: var(--accent);
      color: #fff;
    }

    /* Success State */
    .btn-success {
      background: var(--primary) !important;
      color: #000 !important;
      border-color: transparent !important;
      animation: pulseGreen 0.4s ease;
    }
    @keyframes pulseGreen {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    .btn-disabled {
      opacity: 0.5;
      filter: grayscale(1);
      pointer-events: none;
    }

    /* SCREENS (Full Page Modals) */
    .screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #020617; /* Solid background for screens */
      z-index: 100;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      animation: slideInRight 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    .screen.closing {
      animation: slideOutRight 0.25s forwards;
    }
    @keyframes slideOutRight {
      to { transform: translateX(100%); }
    }

    .nav-bar {
      display: flex;
      align-items: center;
      padding: 16px;
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .nav-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 36px; height: 36px;
      border-radius: 50%;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .nav-title {
      font-size: 17px;
      font-weight: 700;
      margin-left: 12px;
    }

    /* DETAIL VIEW ELEMENTS */
    .detail-hero {
      width: 100%;
      height: 300px;
      object-fit: cover;
      mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
    }
    .detail-body { padding: 20px; padding-bottom: 100px; }
    .detail-price-big { font-size: 28px; font-weight: 800; color: var(--primary); text-shadow: 0 0 20px rgba(16,185,129,0.3); }
    .detail-name-big { font-size: 22px; font-weight: 700; margin: 4px 0 16px; line-height: 1.2; }
    
    .opt-title { font-size: 13px; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .opts-wrap { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .opt-btn {
      padding: 10px 18px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .opt-btn.active {
      background: var(--accent);
      border-color: transparent;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
      transform: translateY(-2px);
    }
    .opt-btn.disabled { opacity: 0.3; pointer-events: none; text-decoration: line-through; }

    /* FLOATING CART */
    .float-dock {
      position: fixed;
      bottom: 20px; left: 16px; right: 16px;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
      transform: translateY(150%);
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 50;
    }
    .float-dock.visible { transform: translateY(0); }
    
    .dock-info { padding-left: 12px; display: flex; flex-direction: column; }
    .dock-total { font-weight: 800; font-size: 16px; color: #fff; }
    .dock-count { font-size: 12px; color: var(--text-sec); }
    
    .dock-btn {
      background: var(--primary);
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
      cursor: pointer;
    }
    .dock-btn:active { transform: scale(0.95); }

    /* CART ITEMS LIST */
    .cart-row {
      display: flex; gap: 12px;
      background: rgba(255,255,255,0.03);
      padding: 10px; border-radius: 16px;
      margin-bottom: 12px; align-items: center;
    }
    .cart-img-sm { width: 56px; height: 56px; border-radius: 12px; object-fit: cover; background: #333; }
    .cart-col { flex: 1; }
    .qty-box {
      display: flex; align-items: center;
      background: #000; border-radius: 99px; padding: 2px;
    }
    .qty-btn {
      width: 28px; height: 28px; border-radius: 50%; border: none;
      background: rgba(255,255,255,0.15); color: #fff;
      display: flex; align-items: center; justify-content: center; font-size: 16px;
    }
    .qty-num { width: 24px; text-align: center; font-size: 13px; font-weight: 600; }

    /* CHECKOUT FORM */
    .form-box { padding: 20px; }
    .inp-group { margin-bottom: 20px; }
    .inp-label { display: block; color: var(--text-sec); font-size: 12px; margin-bottom: 8px; margin-left: 4px; text-transform: uppercase; font-weight: 600; }
    .inp-field {
      width: 100%;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 16px; border-radius: 16px;
      color: #fff; font-size: 16px;
      transition: all 0.2s;
    }
    .inp-field:focus { border-color: var(--primary); background: rgba(15, 23, 42, 0.9); }

    .big-btn-full {
      width: 100%;
      padding: 18px;
      background: var(--primary);
      color: #000;
      border: none; border-radius: 18px;
      font-size: 16px; font-weight: 800;
      box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
      margin-top: 20px;
    }
    .big-btn-full:active { transform: scale(0.98); }

    /* EMPTY STATE */
    .empty-s { text-align: center; padding-top: 60px; color: var(--text-sec); }
    .empty-icon { font-size: 60px; margin-bottom: 16px; display: inline-block; animation: floatIcon 4s infinite; }

  </style>
</head>
<body>

  <div id="mainScreen" class="container">
    <div class="header">
      <div class="logo-row">
        <span class="logo-icon">üí®</span>
        <span class="logo-text">Vape Market</span>
      </div>
    </div>

    <div class="search-wrapper">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ (–Ω–∞–ø—Ä. Elf Bar)..." />
    </div>

    <div id="catsContainer" class="cats-row">
      </div>

    <div id="gridContainer" class="grid">
      </div>
  </div>

  <div id="detailScreen" class="screen hidden">
    <div class="nav-bar">
      <button class="nav-btn" onclick="goBack()">‚úï</button>
      <span class="nav-title">–û–±–∑–æ—Ä</span>
    </div>
    <div id="detailContent" style="flex:1;">
      </div>
  </div>

  <div id="cartScreen" class="screen hidden">
    <div class="nav-bar">
      <button class="nav-btn" onclick="goBack()">‚Üì</button>
      <span class="nav-title">–ö–æ—Ä–∑–∏–Ω–∞</span>
      <button onclick="clearCart()" style="margin-left:auto; background:none; border:none; color:var(--danger); font-size:13px; font-weight:600;">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    
    <div id="cartList" class="container" style="padding-top:10px;">
      </div>

    <div id="cartFooter" class="container" style="margin-top:auto; padding-bottom:30px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:18px; font-weight:700;">
        <span>–°—É–º–º–∞:</span>
        <span style="color:var(--primary)" id="cartTotalBig">0 –≥—Ä–Ω</span>
      </div>
      <button class="big-btn-full" onclick="openCheckout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚ûî</button>
    </div>
  </div>

  <div id="checkoutScreen" class="screen hidden">
    <div class="nav-bar">
      <button class="nav-btn" onclick="closeCheckout()">‚Üê</button>
      <span class="nav-title">–î–æ—Å—Ç–∞–≤–∫–∞</span>
    </div>

    <div class="form-box">
      <p style="color:var(--text-sec); font-size:14px; margin-bottom:24px; line-height:1.5;">
        –û—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥! ‚ú®<br>–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ, –∏ –º—ã —Å—Ä–∞–∑—É –Ω–∞—á–Ω–µ–º —Å–æ–±–∏—Ä–∞—Ç—å —Ç–≤–æ–π –∑–∞–∫–∞–∑.
      </p>

      <div class="inp-group">
        <label class="inp-label">–ò–º—è</label>
        <input type="text" id="orderName" class="inp-field" placeholder="–ö–∞–∫ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?" />
      </div>
      <div class="inp-group">
        <label class="inp-label">–¢–µ–ª–µ—Ñ–æ–Ω / Telegram</label>
        <input type="tel" id="orderPhone" class="inp-field" placeholder="+380..." />
      </div>
      <div class="inp-group">
        <label class="inp-label">–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º?</label>
        <input type="text" id="orderAddress" class="inp-field" placeholder="–ì–æ—Ä–æ–¥, ‚Ññ –æ—Ç–¥–µ–ª–µ–Ω–∏—è –ù–ü" />
      </div>
      <div class="inp-group">
        <label class="inp-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input type="text" id="orderComment" class="inp-field" placeholder="–î–µ—Ç–∞–ª–∏..." />
      </div>

      <button id="finishBtn" class="big-btn-full" onclick="submitOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑ ‚úÖ</button>
    </div>
  </div>

  <div id="floatDock" class="float-dock" onclick="openCart()">
    <div class="dock-info">
      <span class="dock-total" id="dockTotal">0 –≥—Ä–Ω</span>
      <span class="dock-count" id="dockCount">0 –ø–æ–∑.</span>
    </div>
    <button class="dock-btn">–ö–æ—Ä–∑–∏–Ω–∞ ‚ûî</button>
  </div>

  <script>
    // --- TELEGRAM SETUP ---
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand(); // Full height
      tg.enableClosingConfirmation(); // Prevent accidental close
      // Match theme colors
      tg.setHeaderColor('#020617');
      tg.setBackgroundColor('#020617');
    }

    // --- HAPTIC FEEDBACK ---
    function haptic(type = 'light') {
      if (!tg) return;
      if (type === 'light') tg.HapticFeedback.impactOccurred('light');
      if (type === 'medium') tg.HapticFeedback.impactOccurred('medium');
      if (type === 'heavy') tg.HapticFeedback.impactOccurred('heavy');
      if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
      if (type === 'error') tg.HapticFeedback.notificationOccurred('error');
    }

    // --- DATA & STATE ---
    let products = [];
    let cart = [];
    let favorites = JSON.parse(localStorage.getItem('vm_favs') || '[]');
    let activeCat = "–í—Å–µ";
    
    // For Detail View
    let curProduct = null;
    let curOption = null;

    // --- INIT ---
    async function init() {
      try {
        const res = await fetch('products.json');
        products = await res.json();
        renderCats();
        renderGrid();
      } catch(e) {
        document.getElementById('gridContainer').innerHTML = "<div style='color:white;text-align:center'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ :(</div>";
      }
    }

    // --- RENDER ---
    function renderCats() {
      const cats = ["–í—Å–µ", ...new Set(products.map(p => p.category))];
      const el = document.getElementById('catsContainer');
      el.innerHTML = cats.map(c => `
        <div class="cat-chip ${c === activeCat ? 'active' : ''}" onclick="setCat('${c}')">
          ${c}
        </div>
      `).join('');
    }

    function setCat(c) {
      if(c !== activeCat) {
        haptic('light');
        activeCat = c;
        renderCats();
        renderGrid();
      }
    }

    function renderGrid() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const list = products.filter(p => 
        (activeCat === "–í—Å–µ" || p.category === activeCat) &&
        p.name.toLowerCase().includes(q)
      );

      const el = document.getElementById('gridContainer');
      el.innerHTML = '';
      
      if(list.length === 0) {
        el.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-sec)">–ü—É—Å—Ç–æ... üõ∏</div>`;
        return;
      }

      list.forEach((p, idx) => {
        // Animation Delay for Stagger Effect
        const delay = idx * 50; 
        
        const hasOptions = p.options && p.options.length > 0;
        const isFav = favorites.includes(p.id);
        
        let inStock = true;
        if (hasOptions) {
            if (!p.options.some(o => o.inStock)) inStock = false;
        } else {
            if (p.inStock === false) inStock = false;
        }

        // Button Logic: "Plus" (Quick Add) OR "Choose" (Arrow)
        let btnHtml = '';
        if (!inStock) {
           btnHtml = `<button class="action-btn btn-disabled">–ù–µ—Ç</button>`;
        } else if (hasOptions) {
           btnHtml = `<button class="action-btn btn-choose" id="btn_${p.id}" onclick="openDetail(${p.id})">–í—ã–±—Ä–∞—Ç—å</button>`;
        } else {
           btnHtml = `<button class="action-btn btn-add" id="btn_${p.id}" onclick="quickAdd(this, ${p.id})">
             <span>+</span> <span>–î–æ–±–∞–≤–∏—Ç—å</span>
           </button>`;
        }

        const div = document.createElement('div');
        div.className = 'card';
        div.style.animationDelay = `${delay}ms`; // Stagger
        
        div.innerHTML = `
          <div class="card-image-box" onclick="openDetail(${p.id})">
            ${p.image ? `<img src="${p.image}" class="card-img" loading="lazy">` : ''}
            <button class="fav-btn ${isFav?'active':''}" onclick="toggleFav(event, ${p.id})">‚ô•</button>
            ${!inStock ? '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;font-weight:700;">SOLD OUT</div>' : ''}
          </div>
          <div class="card-content">
            <div class="card-title" onclick="openDetail(${p.id})">${p.name}</div>
            <div class="card-sub">${p.category}</div>
            <div class="card-footer">
              <div class="price">${p.price} ‚Ç¥</div>
              ${btnHtml}
            </div>
          </div>
        `;
        el.appendChild(div);
      });
    }

    document.getElementById('searchInput').oninput = renderGrid;

    // --- ACTIONS ---

    function toggleFav(e, id) {
      e.stopPropagation();
      haptic('medium');
      if(favorites.includes(id)) favorites = favorites.filter(x=>x!==id);
      else favorites.push(id);
      
      localStorage.setItem('vm_favs', JSON.stringify(favorites));
      e.target.classList.toggle('active');
    }

    // Quick Add Animation
    function quickAdd(btn, id) {
      haptic('success');
      addToCart(id, null, 1);
      
      // Animate Button
      const originalHTML = btn.innerHTML;
      btn.className = "action-btn btn-success";
      btn.innerHTML = "‚úÖ";
      
      setTimeout(() => {
        btn.className = "action-btn btn-add";
        btn.innerHTML = originalHTML;
      }, 1500);
    }

    // --- DETAIL MODAL ---
    function openDetail(id) {
      haptic('light');
      curProduct = products.find(p => p.id === id);
      if(!curProduct) return;

      // Auto Select
      curOption = null;
      if (curProduct.options && curProduct.options.length) {
        const av = curProduct.options.find(o => o.inStock);
        if(av) curOption = av.id;
      }

      renderDetail();
      openScreen('detailScreen');
    }

    function renderDetail() {
      const p = curProduct;
      const el = document.getElementById('detailContent');
      
      let opts = '';
      if(p.options && p.options.length) {
        opts = `
          <div class="opt-title">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∫—É—Å / —Ç–∏–ø:</div>
          <div class="opts-wrap">
            ${p.options.map(o => `
              <div class="opt-btn ${o.id === curOption ? 'active':''} ${!o.inStock ? 'disabled':''}" 
                   onclick="setOption('${o.id}')">
                ${o.name}
              </div>
            `).join('')}
          </div>
        `;
      }

      const canBuy = (p.options && p.options.length) ? (curOption !== null) : (p.inStock !== false);

      el.innerHTML = `
        ${p.image ? `<img src="${p.image}" class="detail-hero">` : ''}
        <div class="detail-body">
           <div class="detail-price-big">${p.price} –≥—Ä–Ω</div>
           <div class="detail-name-big">${p.name}</div>
           
           ${opts}
           
           <div style="font-size:14px; line-height:1.6; color:#cbd5e1; margin-bottom:20px;">
             ${p.descriptionFull || p.descriptionShort || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."}
           </div>

           <button class="big-btn-full" ${!canBuy ? 'disabled style="opacity:0.5"' : ''} onclick="addFromDetail()">
             ${canBuy ? '–í –∫–æ—Ä–∑–∏–Ω—É +1' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
           </button>
        </div>
      `;
    }

    window.setOption = (oid) => {
      haptic('light');
      curOption = oid;
      renderDetail();
    }

    function addFromDetail() {
      if(curProduct.options && !curOption) return;
      haptic('success');
      addToCart(curProduct.id, curOption, 1);
      goBack(); // Close modal
    }

    // --- CART ---
    function addToCart(id, optId, qty) {
      const ex = cart.find(i => i.id === id && i.optionId === optId);
      if(ex) ex.qty += qty;
      else cart.push({ id, optionId: optId, qty });
      updateUI();
    }

    function updateUI() {
      // Sum
      let total = 0;
      let count = 0;
      cart.forEach(c => {
        const p = products.find(x => x.id === c.id);
        if(p) {
          total += p.price * c.qty;
          count += c.qty;
        }
      });

      // Dock
      const dock = document.getElementById('floatDock');
      if(count > 0) dock.classList.add('visible');
      else dock.classList.remove('visible');

      document.getElementById('dockTotal').innerText = total + " –≥—Ä–Ω";
      document.getElementById('dockCount').innerText = count + " —à—Ç.";
      
      document.getElementById('cartTotalBig').innerText = total + " –≥—Ä–Ω";
    }

    function openCart() {
      haptic('medium');
      renderCartList();
      openScreen('cartScreen');
    }

    function renderCartList() {
      const list = document.getElementById('cartList');
      list.innerHTML = '';
      
      if(cart.length === 0) {
        list.innerHTML = `
          <div class="empty-s">
            <span class="empty-icon">üï∏Ô∏è</span>
            <p>–í –∫–æ—Ä–∑–∏–Ω–µ –ø—É—Å—Ç–æ</p>
          </div>`;
        document.getElementById('cartFooter').classList.add('hidden');
        return;
      }
      document.getElementById('cartFooter').classList.remove('hidden');

      cart.forEach((item, idx) => {
        const p = products.find(x => x.id === item.id);
        if(!p) return;
        
        let optName = '';
        if(item.optionId) {
          const o = p.options.find(opt => opt.id === item.optionId);
          if(o) optName = o.name;
        }

        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          ${p.image ? `<img src="${p.image}" class="cart-img-sm">` : ''}
          <div class="cart-col">
            <div style="font-weight:600; font-size:14px;">${p.name}</div>
            <div style="font-size:12px; color:var(--text-sec); margin:2px 0;">${optName}</div>
            <div style="color:var(--primary); font-weight:700;">${p.price * item.qty} –≥—Ä–Ω</div>
          </div>
          <div class="qty-box">
             <button class="qty-btn" onclick="modCart(${idx}, -1)">‚àí</button>
             <div class="qty-num">${item.qty}</div>
             <button class="qty-btn" onclick="modCart(${idx}, 1)">+</button>
          </div>
        `;
        list.appendChild(row);
      });
    }

    function modCart(idx, delta) {
      haptic('light');
      cart[idx].qty += delta;
      if(cart[idx].qty <= 0) cart.splice(idx, 1);
      updateUI();
      renderCartList();
      if(cart.length === 0) goBack();
    }

    function clearCart() {
      haptic('medium');
      if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
        cart = [];
        updateUI();
        goBack();
      }
    }

    // --- CHECKOUT ---
    function openCheckout() {
      haptic('light');
      document.getElementById('cartScreen').classList.add('hidden'); // swap
      openScreen('checkoutScreen');
    }

    function closeCheckout() {
      haptic('light');
      document.getElementById('checkoutScreen').classList.add('hidden');
      document.getElementById('cartScreen').classList.remove('hidden'); // back to cart
    }

    function submitOrder() {
      const name = document.getElementById('orderName').value.trim();
      const phone = document.getElementById('orderPhone').value.trim();
      const addr = document.getElementById('orderAddress').value.trim();
      const comm = document.getElementById('orderComment').value.trim();

      if(!name || !phone) {
        haptic('error');
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ò–º—è –∏ –¢–µ–ª–µ—Ñ–æ–Ω!');
        return;
      }
      
      haptic('success');
      
      // CONFETTI EFFECT
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#10b981', '#6366f1', '#ffffff']
      });

      const payload = {
        action: "cart_checkout",
        items: cart.map(i => ({ productId: i.id, optionId: i.optionId, qty: i.qty })),
        contact: { name, phone, address: addr, comment: comm }
      };

      // Delay to show confetti before closing
      setTimeout(() => {
        if(tg && tg.sendData) tg.sendData(JSON.stringify(payload));
        else alert('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É (—Ç–µ—Å—Ç)');
      }, 1500);
    }

    // --- NAV UTILS ---
    function openScreen(id) {
      document.getElementById(id).classList.remove('hidden');
    }
    
    function goBack() {
      haptic('light');
      // Simple close logic for modals
      document.getElementById('detailScreen').classList.add('hidden');
      document.getElementById('cartScreen').classList.add('hidden');
    }

    init();
  </script>
</body>
</html>
