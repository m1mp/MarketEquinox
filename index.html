<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Vape Market</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #020617 0, #020617 30%, #020617 100%);
      color: #e5e7eb;
      padding: 16px;
      min-height: 100vh;
    }

    .app {
      max-width: 800px;
      margin: 0 auto;
      padding-bottom: 40px;
    }

    /* HEADER */
    .header {
      margin-bottom: 16px;
    }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin-bottom: 8px;
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .header-sub {
      font-size: 13px;
      color: #9ca3af;
    }

    /* TOP BAR & FILTERS */
    .top-bar {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 18px;
      padding: 10px 10px 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      backdrop-filter: blur(10px);
    }

    .categories {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .cat-btn {
      flex-shrink: 0;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      border: 1px solid rgba(34, 197, 94, 0.4);
      background: rgba(15, 23, 42, 0.9);
      cursor: pointer;
      white-space: nowrap;
      color: #e5e7eb;
      transition: all 0.15s ease;
    }

    .cat-btn:hover {
      background: rgba(34, 197, 94, 0.18);
      border-color: rgba(34, 197, 94, 0.9);
    }

    .cat-btn.active {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: transparent;
      color: #f9fafb;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.8);
    }

    .filters-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 6px 12px;
      font-size: 13px;
      outline: none;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      min-width: 0;
    }

    .sort-select {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 6px 10px;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      outline: none;
    }

    .counter {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    /* PRODUCTS LIST */
    .products {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), rgba(15, 23, 42, 0.97));
      border-radius: 20px;
      padding: 14px 16px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.12s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(34, 197, 94, 0.8);
    }

    .card-main {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .card-image-wrap {
      width: 70px;
      height: 70px;
      border-radius: 16px;
      overflow: hidden;
      flex-shrink: 0;
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.2), rgba(15, 23, 42, 1));
    }

    .card-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-content {
      flex: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .card-title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-sku, .card-category {
      font-size: 11px;
      color: #6b7280;
    }

    .card-price-box {
      text-align: right;
      min-width: 80px;
    }

    .card-price-main {
      font-size: 16px;
      font-weight: 700;
      color: #4ade80;
      white-space: nowrap;
    }

    .card-price-old {
      font-size: 11px;
      color: #9ca3af;
      text-decoration: line-through;
    }

    .card-footer {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    /* BUTTONS */
    .btn, .btn-secondary {
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 100%;
      cursor: pointer;
    }

    .btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: none;
      color: white;
      box-shadow: 0 6px 16px rgba(22, 163, 74, 0.5);
    }
    .btn:active { transform: translateY(1px); }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
    }
    .btn-secondary:active { transform: translateY(1px); }

    .btn[disabled], .btn-secondary[disabled] {
      opacity: 0.5;
      cursor: default;
      filter: grayscale(1);
    }

    .bottom-actions {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .hint {
      margin-top: 6px;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
    }

    /* DETAIL VIEW */
    .detail, .cart-view, .checkout-view {
      margin-top: 16px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), rgba(15, 23, 42, 0.98));
      border-radius: 20px;
      padding: 16px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 1);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .detail-image-wrap {
      width: 100%;
      max-width: 260px;
      border-radius: 18px;
      overflow: hidden;
      margin-bottom: 10px;
      align-self: center;
    }
    .detail-image { width: 100%; display: block; }

    .detail-title { font-size: 18px; font-weight: 700; }
    .detail-price-main { font-size: 19px; font-weight: 700; color: #4ade80; }

    .detail-tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .tag {
      font-size: 11px; padding: 2px 8px; border-radius: 999px;
      background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(148, 163, 184, 0.7);
    }

    /* Options */
    .option-pill {
      font-size: 12px; padding: 4px 10px; border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      cursor: pointer; display: inline-block; margin: 2px;
    }
    .option-pill.active {
      background: linear-gradient(135deg, #4f46e5, #0ea5e9);
      border-color: transparent;
      color: #fff;
    }
    .option-pill.disabled { opacity: 0.4; pointer-events: none; text-decoration: line-through; }

    /* CART */
    .cart-item {
      display: flex; gap: 10px; align-items: flex-start; padding: 8px;
      border-radius: 14px; border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.98);
    }
    .cart-item-image-wrap { width: 48px; height: 48px; border-radius: 10px; overflow: hidden; flex-shrink: 0; }
    .cart-item-image { width: 100%; height: 100%; object-fit: cover; }
    .cart-item-main { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .cart-item-controls { display: flex; justify-content: space-between; margin-top: 4px; }
    .qty-controls { display: inline-flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.3); border-radius: 999px; padding: 2px 8px; }

    /* CHECKOUT FORM */
    .form-group {
      margin-bottom: 12px;
    }
    .form-label {
      display: block;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
      margin-left: 4px;
    }
    .form-input {
      width: 100%;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.6);
      border-radius: 12px;
      padding: 10px 12px;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
    }
    .form-input:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }
    textarea.form-input {
      resize: vertical;
      min-height: 60px;
    }

    /* STATUS BADGES */
    .status-available { border-color: rgba(34, 197, 94, 0.8); color: #bbf7d0; background: rgba(22, 163, 74, 0.2); }
    .status-out { border-color: rgba(248, 113, 113, 0.8); color: #fecaca; background: rgba(127, 29, 29, 0.4); }
    .discount-badge { background: rgba(22, 163, 74, 0.15); color: #bbf7d0; border: 1px solid rgba(34, 197, 94, 0.8); }

    .hidden { display: none !important; }

    /* Age Gate */
    .age-gate {
      position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); z-index: 9999;
      display: flex; align-items: center; justify-content: center; padding: 16px;
    }
    .age-card {
      background: #1e293b; border-radius: 20px; padding: 20px;
      border: 1px solid #334155; text-align: center; max-width: 350px;
    }
  </style>
</head>
<body>

  <div id="ageGate" class="age-gate hidden">
    <div class="age-card">
      <h2>–¢–µ–±–µ —É–∂–µ –µ—Å—Ç—å 18 –ª–µ—Ç?</h2>
      <p style="font-size:13px; color:#94a3b8; margin:10px 0 20px;">–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏–º.</p>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <button id="btnOver18" class="btn">–î–∞, –º–Ω–µ –µ—Å—Ç—å 18</button>
        <button id="btnUnder18" class="btn-secondary">–ù–µ—Ç, –º–Ω–µ –º–µ–Ω—å—à–µ 18</button>
      </div>
    </div>
  </div>

  <div class="app">
    <div class="header">
      <div class="header-badge"><span>üí®</span><span>Vape Market</span></div>
      <div class="header-title">–ö–∞—Ç–∞–ª–æ–≥</div>
      <div class="header-sub">–õ—É—á—à–∏–µ –¥–µ–≤–∞–π—Å—ã –∏ –∂–∏–¥–∫–æ—Å—Ç–∏</div>
    </div>

    <div id="listView">
      <div class="top-bar">
        <div id="categoryBar" class="categories"></div>
        <div class="filters-row">
          <input id="searchInput" class="search-input" type="text" placeholder="–ü–æ–∏—Å–∫..." />
          <select id="sortSelect" class="sort-select">
            <option value="default">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
            <option value="price_asc">–¶–µ–Ω–∞ ‚Üë</option>
            <option value="price_desc">–¶–µ–Ω–∞ ‚Üì</option>
          </select>
        </div>
        <div id="counter" class="counter"></div>
      </div>

      <div id="products" class="products"></div>

      <div class="bottom-actions">
        <button id="moreBtn" class="btn btn-secondary" style="display:none;">–ï—â—ë</button>
        <button id="cartBtn" class="btn" style="display:none;">–ö–æ—Ä–∑–∏–Ω–∞</button>
      </div>
    </div>

    <div id="detailView" class="hidden">
      <button id="backBtn" class="btn btn-secondary" style="margin-bottom:10px;">‚Üê –ù–∞–∑–∞–¥</button>
      <div id="detailCard" class="detail"></div>
    </div>

    <div id="cartView" class="hidden">
      <button id="cartBackBtn" class="btn btn-secondary" style="margin-bottom:10px;">‚Üê –ö–∞—Ç–∞–ª–æ–≥</button>
      <div class="cart-view">
        <div class="cart-title" style="font-size:18px; font-weight:700;">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div id="cartItems" style="margin-top:10px; display:flex; flex-direction:column; gap:10px;"></div>
        <div id="cartEmpty" class="hidden" style="color:#94a3b8; font-size:13px;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
        <div style="margin-top:10px; font-weight:700; color:#4ade80;" id="cartTotalLabel"></div>
        
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button id="cartClearBtn" class="btn-secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="cartCheckoutBtn" class="btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
    </div>

    <div id="checkoutView" class="hidden">
      <button id="checkoutBackBtn" class="btn btn-secondary" style="margin-bottom:10px;">‚Üê –ù–∞–∑–∞–¥</button>
      
      <div class="checkout-view">
        <div class="detail-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
        <p style="font-size:13px; color:#9ca3af;">–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏</p>

        <div class="form-group">
          <label class="form-label">–ò–º—è</label>
          <input type="text" id="orderName" class="form-input" placeholder="–ö–∞–∫ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?" />
        </div>

        <div class="form-group">
          <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω / Telegram</label>
          <input type="text" id="orderPhone" class="form-input" placeholder="+380..." />
        </div>

        <div class="form-group">
          <label class="form-label">–ì–æ—Ä–æ–¥ –∏ –û—Ç–¥–µ–ª–µ–Ω–∏–µ –ù–ü</label>
          <input type="text" id="orderAddress" class="form-input" placeholder="–ö–∏–µ–≤, –æ—Ç–¥. ‚Ññ1" />
        </div>

        <div class="form-group">
          <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="orderComment" class="form-input" placeholder="–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞..."></textarea>
        </div>

        <button id="submitOrderBtn" class="btn" style="margin-top:8px;">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </div>

  </div>

  <script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    let products = [];
    let cart = []; // {id, optionId, qty}
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    let pendingOrderPayload = null;

    // –°—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
    const views = {
      list: document.getElementById("listView"),
      detail: document.getElementById("detailView"),
      cart: document.getElementById("cartView"),
      checkout: document.getElementById("checkoutView")
    };

    // --- –õ–û–ì–ò–ö–ê ---

    function switchView(viewName) {
      Object.values(views).forEach(el => el.classList.add("hidden"));
      views[viewName].classList.remove("hidden");
      window.scrollTo(0, 0);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞
    async function loadProducts() {
      try {
        const res = await fetch("products.json");
        products = await res.json();
        renderCategories();
        renderProducts();
      } catch (e) {
        document.getElementById("products").innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞</p>";
      }
    }

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    let activeCategory = "–í—Å–µ";
    function renderCategories() {
      const cats = ["–í—Å–µ", ...new Set(products.map(p => p.category))];
      const bar = document.getElementById("categoryBar");
      bar.innerHTML = "";
      cats.forEach(c => {
        const btn = document.createElement("button");
        btn.className = `cat-btn ${c === activeCategory ? 'active' : ''}`;
        btn.textContent = c;
        btn.onclick = () => {
          activeCategory = c;
          renderCategories();
          renderProducts();
        };
        bar.appendChild(btn);
      });
    }

    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞
    let visibleCount = 8;
    function renderProducts() {
      const container = document.getElementById("products");
      const query = document.getElementById("searchInput").value.toLowerCase();
      const sortMode = document.getElementById("sortSelect").value;
      
      let list = products.filter(p => 
        (activeCategory === "–í—Å–µ" || p.category === activeCategory) &&
        p.name.toLowerCase().includes(query)
      );

      if (sortMode === 'price_asc') list.sort((a,b) => a.price - b.price);
      if (sortMode === 'price_desc') list.sort((a,b) => b.price - a.price);

      const total = list.length;
      document.getElementById("counter").textContent = `–ù–∞–π–¥–µ–Ω–æ: ${total}`;
      
      container.innerHTML = "";
      list.slice(0, visibleCount).forEach(p => {
        const hasOpts = p.options && p.options.length > 0;
        const inStock = hasOpts ? p.options.some(o=>o.inStock) : p.inStock;
        
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-main">
            ${p.image ? `<div class="card-image-wrap"><img src="${p.image}" class="card-image"></div>` : ''}
            <div class="card-content">
              <div class="card-header">
                <div class="card-title-wrap">
                  <div class="card-title">${p.name}</div>
                  <div class="card-sku">${p.category}</div>
                </div>
                <div class="card-price-main">${p.price} –≥—Ä–Ω</div>
              </div>
              <div class="card-footer">
                <button class="btn-secondary" onclick="openDetail(${p.id})">–ò–Ω—Ñ–æ</button>
                <button class="btn ${!inStock?'disabled':''}" onclick="${inStock ? `addToCartQuick(${p.id})` : ''}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      const moreBtn = document.getElementById("moreBtn");
      moreBtn.style.display = list.length > visibleCount ? "inline-flex" : "none";
      moreBtn.onclick = () => { visibleCount += 8; renderProducts(); };
      
      updateCartBtn();
    }

    document.getElementById("searchInput").oninput = renderProducts;
    document.getElementById("sortSelect").onchange = renderProducts;

    // –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
    let currentDetail = null;
    let currentOption = null;

    function openDetail(id) {
      currentDetail = products.find(p => p.id === id);
      if(!currentDetail) return;
      
      // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –æ–ø—Ü–∏–∏
      currentOption = null;
      if (currentDetail.options && currentDetail.options.length) {
        const avail = currentDetail.options.find(o => o.inStock);
        if (avail) currentOption = avail.id;
      }

      renderDetailCard();
      switchView("detail");
    }

    function renderDetailCard() {
      const p = currentDetail;
      const optsHtml = p.options ? `
        <div style="margin-top:10px;">
          <div style="font-size:12px;color:#94a3b8;margin-bottom:4px;">${p.optionLabel || "–í–∞—Ä–∏–∞–Ω—Ç"}:</div>
          ${p.options.map(o => `
            <div class="option-pill ${o.id === currentOption ? 'active' : ''} ${!o.inStock ? 'disabled' : ''}"
                 onclick="selectOption('${o.id}')">
              ${o.name}
            </div>
          `).join('')}
        </div>
      ` : '';

      document.getElementById("detailCard").innerHTML = `
        <div class="detail-title">${p.name}</div>
        <div class="detail-price-main">${p.price} –≥—Ä–Ω</div>
        ${p.image ? `<div class="detail-image-wrap"><img src="${p.image}" class="detail-image"></div>` : ''}
        ${optsHtml}
        <div style="font-size:13px; color:#cbd5e1; margin-top:8px;">${p.descriptionFull || p.descriptionShort || ""}</div>
        
        <div style="margin-top:16px; display:flex; gap:8px;">
          <button class="btn-secondary" style="flex:1" onclick="addToCartDetail()">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          <button class="btn" style="flex:1" onclick="buyNowDetail()">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
        </div>
      `;
    }

    window.selectOption = (oid) => {
      currentOption = oid;
      renderDetailCard();
    };

    // –ö–æ—Ä–∑–∏–Ω–∞
    function addToCartQuick(id) {
      const p = products.find(x => x.id === id);
      if (p.options && p.options.length) {
        openDetail(id); // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–ø—Ü–∏–∏, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∫—É
      } else {
        modifyCart(id, null, 1);
      }
    }

    function addToCartDetail() {
      if (currentDetail.options && !currentOption) return alert("–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç!");
      modifyCart(currentDetail.id, currentOption, 1);
      alert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
      closeDetail();
    }

    function modifyCart(id, optId, delta) {
      const existing = cart.find(i => i.id === id && i.optionId === optId);
      if (existing) {
        existing.qty += delta;
        if (existing.qty <= 0) cart = cart.filter(i => i !== existing);
      } else if (delta > 0) {
        cart.push({ id, optionId: optId, qty: delta });
      }
      updateCartBtn();
      if (!views.cart.classList.contains("hidden")) renderCart();
    }

    function updateCartBtn() {
      const btn = document.getElementById("cartBtn");
      const count = cart.reduce((a,b) => a + b.qty, 0);
      const total = cart.reduce((sum, item) => {
        const p = products.find(x => x.id === item.id);
        return sum + (p ? p.price * item.qty : 0);
      }, 0);
      
      if (count > 0) {
        btn.style.display = "inline-flex";
        btn.textContent = `–ö–æ—Ä–∑–∏–Ω–∞ (${count} ¬∑ ${total} –≥—Ä–Ω)`;
      } else {
        btn.style.display = "none";
      }
    }

    function renderCart() {
      const container = document.getElementById("cartItems");
      container.innerHTML = "";
      let total = 0;

      if (cart.length === 0) {
        document.getElementById("cartEmpty").classList.remove("hidden");
        document.getElementById("cartTotalLabel").textContent = "0 –≥—Ä–Ω";
        return;
      }
      document.getElementById("cartEmpty").classList.add("hidden");

      cart.forEach(item => {
        const p = products.find(x => x.id === item.id);
        if (!p) return;
        const linePrice = p.price * item.qty;
        total += linePrice;
        
        let optName = "";
        if (item.optionId) {
          const o = p.options.find(opt => opt.id === item.optionId);
          if (o) optName = o.name;
        }

        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          ${p.image ? `<div class="cart-item-image-wrap"><img src="${p.image}" class="cart-item-image"></div>` : ''}
          <div class="cart-item-main">
            <div style="font-weight:500; font-size:14px;">${p.name}</div>
            ${optName ? `<div style="font-size:12px;color:#94a3b8">${optName}</div>` : ''}
            <div class="cart-item-controls">
               <span style="font-weight:700; color:#4ade80;">${linePrice} –≥—Ä–Ω</span>
               <div class="qty-controls">
                 <span onclick="modifyCart(${item.id}, '${item.optionId||''}', -1)">‚àí</span>
                 <span>${item.qty}</span>
                 <span onclick="modifyCart(${item.id}, '${item.optionId||''}', 1)">+</span>
               </div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
      document.getElementById("cartTotalLabel").textContent = `–ò—Ç–æ–≥–æ: ${total} –≥—Ä–Ω`;
    }

    // --- CHECKOUT SYSTEM ---

    // 1. –ë—ã—Å—Ç—Ä–∞—è –ø–æ–∫—É–ø–∫–∞ (Buy Now)
    function buyNowDetail() {
      if (currentDetail.options && !currentOption) return alert("–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç!");
      
      // –ì–æ—Ç–æ–≤–∏–º payload, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º, –∞ –∏–¥–µ–º –Ω–∞ —Ñ–æ—Ä–º—É
      pendingOrderPayload = {
        action: "buy",
        productId: currentDetail.id,
        optionId: currentOption || null
      };
      
      switchView("checkout");
    }

    // 2. –ü–æ–∫—É–ø–∫–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
    document.getElementById("cartCheckoutBtn").onclick = () => {
      if (cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
      
      pendingOrderPayload = {
        action: "cart_checkout",
        items: cart.map(i => ({
          productId: i.id,
          optionId: i.optionId,
          qty: i.qty
        }))
      };

      switchView("checkout");
    };

    // 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –∏–∑ —Ñ–æ—Ä–º—ã
    document.getElementById("submitOrderBtn").onclick = () => {
      const name = document.getElementById("orderName").value.trim();
      const phone = document.getElementById("orderPhone").value.trim();
      const address = document.getElementById("orderAddress").value.trim();
      const comment = document.getElementById("orderComment").value.trim();

      if (!name || !phone) {
        return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏ –ò–º—è –∏ –¢–µ–ª–µ—Ñ–æ–Ω, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è.");
      }

      if (!pendingOrderPayload) return alert("–û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–Ω–æ–≤–æ.");

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ payload
      pendingOrderPayload.contact = {
        name: name,
        phone: phone,
        address: address,
        comment: comment,
        preferred: "telegram"
      };

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É
      if (tg && tg.sendData) {
        tg.sendData(JSON.stringify(pendingOrderPayload));
        tg.close();
      } else {
        console.log("SENDING:", pendingOrderPayload);
        alert("–ó–∞–∫–∞–∑ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω! (–í Telegram WebApp —ç—Ç–æ –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è)");
      }
    };

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ "–ù–∞–∑–∞–¥"
    document.getElementById("backBtn").onclick = () => {
      switchView("list");
      currentDetail = null;
    };
    document.getElementById("cartBtn").onclick = () => {
      renderCart();
      switchView("cart");
    };
    document.getElementById("cartBackBtn").onclick = () => {
      switchView("list");
    };
    document.getElementById("cartClearBtn").onclick = () => {
      cart = [];
      updateCartBtn();
      renderCart();
    };
    document.getElementById("checkoutBackBtn").onclick = () => {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è —Ç—É–¥–∞, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ - –≤ —Å–ø–∏—Å–æ–∫ –∏–ª–∏ –∫–æ—Ä–∑–∏–Ω—É)
      if (pendingOrderPayload && pendingOrderPayload.action === "cart_checkout") {
        switchView("cart");
      } else {
        if(currentDetail) switchView("detail");
        else switchView("list");
      }
    };

    // Age Gate Logic
    const ageGate = document.getElementById("ageGate");
    if (!localStorage.getItem("age_confirmed")) {
      ageGate.classList.remove("hidden");
    }
    document.getElementById("btnOver18").onclick = () => {
      localStorage.setItem("age_confirmed", "true");
      ageGate.classList.add("hidden");
    };
    document.getElementById("btnUnder18").onclick = () => {
      if(tg) tg.close();
      else document.body.innerHTML = "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω";
    };

    // Init
    loadProducts();

    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ü–≤–µ—Ç–µ —Ç–µ–º—ã –¥–ª—è Telegram
    if(tg) {
      tg.setHeaderColor('#0f172a');
      tg.setBackgroundColor('#020617');
    }

  </script>
</body>
</html>
