<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Vape Market v4</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --bg-color: #050816;
      --card-bg: rgba(15, 23, 42, 0.7);
      --card-border: 1px solid rgba(255, 255, 255, 0.08);
      --primary: #22d3ee;
      --accent: #f97316;
      --danger: #ef4444;
      --text-main: #f8fafc;
      --text-sec: #94a3b8;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
      margin: 0; padding: 0;
      background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.12), transparent 25%),
                  radial-gradient(circle at 80% 10%, rgba(249,115,22,0.12), transparent 22%),
                  linear-gradient(-45deg, #050816, #0b1226, #0e162d, #050816);
      background-size: 400% 400%;
      animation: gradientBG 18s ease infinite;
      font-family: "Space Grotesk", "SF Pro Display", "Segoe UI", Roboto, sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    ::-webkit-scrollbar { width: 0; background: transparent; }

    .container { max-width: 600px; margin: 0 auto; padding: 16px; position: relative; z-index: 1; }
    .hidden { display: none !important; }

    /* HERO */
    .hero {
      position: relative; overflow: hidden; padding: 18px; margin-bottom: 14px;
      border-radius: 22px; background: linear-gradient(135deg, rgba(34,211,238,0.15), rgba(249,115,22,0.12), rgba(15,23,42,0.8));
      border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .hero::after {
      content: ""; position: absolute; inset: 0; background: radial-gradient(circle at 80% 10%, rgba(255,255,255,0.08), transparent 35%);
      mix-blend-mode: screen; pointer-events: none;
    }
    .hero-kicker { font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-sec); margin-bottom: 6px; }
    .hero-title { font-size: 24px; font-weight: 700; line-height: 1.2; margin: 0 0 8px; }
    .hero-title span { color: var(--primary); }
    .hero-desc { margin: 0 0 12px; color: #cbd5e1; font-size: 14px; }
    .hero-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .hero-btn, .hero-ghost {
      border: none; padding: 12px 14px; border-radius: 12px; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.2s;
    }
    .hero-btn { background: var(--primary); color: #02121c; box-shadow: 0 10px 30px rgba(34,211,238,0.35); }
    .hero-btn:active { transform: translateY(1px); }
    .hero-ghost { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.12); }

    /* STORIES SECTION */
    .stories-wrap {
      display: flex; gap: 14px; overflow-x: auto; padding: 4px 16px 16px; margin: 0 -16px;
    }
    .story-item {
      display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer;
    }
    .story-ring {
      width: 62px; height: 62px; border-radius: 50%; padding: 2px;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      position: relative; transition: transform 0.2s;
    }
    .story-ring.seen { background: #334155; }
    .story-img {
      width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
      border: 3px solid #020617; /* gap color */
      background: #1e293b;
    }
    .story-text { font-size: 11px; max-width: 64px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .story-item:active .story-ring { transform: scale(0.95); }

    /* HEADER & SEARCH */
    .header { display: flex; align-items: center; margin: 8px 0 16px; gap: 8px; }
    .logo-text { font-size: 20px; font-weight: 800; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    
    .search-wrapper { position: relative; margin-bottom: 16px; }
    .search-input {
      width: 100%; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px);
      border: var(--card-border); border-radius: 16px; padding: 12px 12px 12px 42px;
      color: #fff; font-size: 15px; transition: 0.3s;
    }
    .search-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }
    .search-icon { position: absolute; left: 14px; top: 12px; opacity: 0.5; }

    /* CATS & GRID */
    .cats-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 16px; }
    .cat-chip {
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
      padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; white-space: nowrap;
      color: var(--text-sec); cursor: pointer; transition: 0.2s;
    }
    .cat-chip.active { background: var(--primary); color: #000; font-weight: 700; border-color: transparent; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card {
      background: var(--card-bg); border: var(--card-border); border-radius: 20px;
      overflow: hidden; display: flex; flex-direction: column; position: relative;
      animation: slideUp 0.5s cubic-bezier(0.16,1,0.3,1) forwards; opacity: 0;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .card-image-box { width: 100%; padding-top: 100%; position: relative; background: #1e293b; overflow: hidden; }
    .card-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
    .card:active .card-img { transform: scale(1.1); }
    
    .badges { position: absolute; top: 8px; left: 8px; display: flex; flex-direction: column; gap: 4px; }
    .badge { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; color: #fff; }
    .badge-hit { background: #f59e0b; }
    .badge-new { background: #3b82f6; }

    .fav-btn {
      position: absolute; top: 8px; right: 8px; width: 28px; height: 28px;
      background: rgba(0,0,0,0.4); border-radius: 50%; border: none; color: #fff;
      display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);
    }
    .fav-btn.active { color: #ef4444; background: rgba(255,255,255,0.9); }

    .card-content { padding: 12px; flex: 1; display: flex; flex-direction: column; }
    .card-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; flex: 1; }
    .card-sub { font-size: 11px; color: var(--text-sec); margin-bottom: 10px; }
    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    .price { font-size: 15px; font-weight: 700; color: var(--primary); }
    
    .btn-mini {
      height: 32px; padding: 0 12px; border-radius: 10px; border: none; font-size: 12px; font-weight: 700;
      display: flex; align-items: center; gap: 4px; transition: 0.2s;
    }
    .btn-add { background: rgba(16,185,129,0.15); color: var(--primary); }
    .btn-choose { background: rgba(99,102,241,0.15); color: var(--accent); }
    .btn-add:active { background: var(--primary); color: #000; transform: scale(0.9); }

    /* SCREENS */
    .screen {
      position: fixed; inset: 0; background: #020617; z-index: 100; overflow-y: auto;
      display: flex; flex-direction: column; animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    .nav-bar {
      display: flex; align-items: center; padding: 16px; background: rgba(2,6,23,0.8);
      backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 10;
    }
    .nav-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1);
      border: none; color: #fff; font-size: 18px; display: flex; align-items: center; justify-content: center;
    }
    .nav-title { font-size: 17px; font-weight: 700; margin-left: 12px; }

    /* CART & CHECKOUT */
    .cart-row {
      display: flex; gap: 12px; background: rgba(255,255,255,0.03); padding: 10px;
      border-radius: 16px; margin-bottom: 12px; align-items: center;
    }
    .cart-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; background: #333; }
    .qty-ctrl { display: flex; background: #000; border-radius: 50px; padding: 2px; }
    .qty-btn { width: 26px; height: 26px; border-radius: 50%; border: none; background: #333; color: #fff; }
    .qty-val { width: 24px; text-align: center; font-size: 13px; font-weight: 600; line-height: 26px; }

    /* PROMO CODE INPUT */
    .promo-box {
      background: rgba(99,102,241,0.1); border: 1px dashed var(--accent);
      border-radius: 14px; padding: 12px; margin-top: 10px; display: flex; gap: 8px;
    }
    .promo-input {
      flex: 1; background: transparent; border: none; color: #fff; font-size: 14px; text-transform: uppercase;
    }
    .promo-apply {
      color: var(--accent); font-weight: 700; font-size: 13px; background: none; border: none;
    }

    /* STORY VIEWER */
    #storyViewer {
      position: fixed; inset: 0; background: #000; z-index: 200;
      display: flex; flex-direction: column; justify-content: center;
    }
    .story-full-img { width: 100%; height: auto; max-height: 80vh; object-fit: contain; }
    .story-progress {
      position: absolute; top: 10px; left: 10px; right: 10px; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px;
    }
    .story-bar { height: 100%; background: #fff; width: 0%; transition: width 0.1s linear; }

    /* FLOATING DOCK */
    .dock {
      position: fixed; bottom: 20px; left: 16px; right: 16px;
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(16px);
      border-radius: 20px; padding: 12px; display: flex; justify-content: space-between; align-items: center;
      transform: translateY(150%); transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); border: 1px solid rgba(255,255,255,0.1);
      z-index: 50; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .dock.visible { transform: translateY(0); }
    .dock-btn { background: var(--primary); color: #000; border: none; padding: 10px 20px; border-radius: 12px; font-weight: 700; }

    /* DETAIL STYLES */
    .detail-img { width: 100%; height: 300px; object-fit: cover; mask-image: linear-gradient(to bottom, black 80%, transparent); }
    .opt-chip {
      padding: 8px 14px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      color: #fff; font-size: 13px; margin: 0 6px 6px 0; display: inline-block; transition: 0.2s;
    }
    .opt-chip.active { background: var(--accent); border-color: transparent; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }

    .inp-field { width: 100%; background: rgba(15,23,42,0.5); border: 1px solid #334155; padding: 14px; border-radius: 12px; color: #fff; margin-bottom: 12px; }
    .big-btn { width: 100%; padding: 16px; background: var(--primary); border-radius: 16px; border: none; font-weight: 800; font-size: 16px; margin-top: 10px; }
  </style>
</head>
<body>

  <div id="mainScreen" class="container">
    <div class="header">
      <span style="font-size:24px;">üí®</span>
      <span class="logo-text">Vape Market</span>
    </div>

    <div class="hero">
      <div class="hero-kicker">–Ω–æ–≤—ã–µ –≤–∫—É—Å—ã</div>
      <div class="hero-title">Vape Market <span>Express</span></div>
      <p class="hero-desc">–°–≤–µ–∂–∏–µ –¥–µ–≤–∞–π—Å—ã –∏ –∂–∏–¥–∫–æ—Å—Ç–∏, –±—ã—Å—Ç—Ä—ã–µ –ø–æ–¥–±–æ—Ä–∫–∏, –±–æ–Ω—É—Å—ã –∑–∞ –∫–æ–º–±–æ. –í—ã–±–∏—Ä–∞–π —Ç–æ, —á—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è.</p>
      <div class="hero-actions">
        <button class="hero-btn" onclick="document.getElementById('searchInput').focus()">–ù–∞–π—Ç–∏ –≤–∫—É—Å</button>
        <button class="hero-ghost" onclick="document.getElementById('catsContainer').scrollIntoView({behavior:'smooth'})">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      </div>
    </div>

    <div class="stories-wrap" id="storiesContainer">
      </div>

    <div class="search-wrapper">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ (Elf Bar, –∂–∏–∂–∞)..." />
    </div>

    <div id="catsContainer" class="cats-row"></div>

    <div style="display:flex; gap:8px; margin-bottom:12px; align-items:center; flex-wrap:wrap;">
      <select id="sortSelect" class="cat-chip" style="padding:8px 12px; cursor:pointer; border:none; background:rgba(255,255,255,0.05);" onchange="renderGrid()">
        <option value="default">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
        <option value="price-asc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
        <option value="price-desc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
        <option value="name-asc">–ù–∞–∑–≤–∞–Ω–∏–µ: –ê-–Ø</option>
        <option value="name-desc">–ù–∞–∑–≤–∞–Ω–∏–µ: –Ø-–ê</option>
      </select>
      <div class="cat-chip" onclick="toggleFilter('stock')" id="filterStock" style="cursor:pointer;">
        <span id="filterStockIcon">‚úì</span> –í –Ω–∞–ª–∏—á–∏–∏
      </div>
      <div class="cat-chip" onclick="toggleFilter('favorites')" id="filterFavorites" style="cursor:pointer;">
        <span id="filterFavoritesIcon">‚ô°</span> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
      </div>
    </div>

    <div id="gridContainer" class="grid"></div>
  </div>

  <div id="detailScreen" class="screen hidden">
    <div class="nav-bar"><button class="nav-btn" onclick="goBack()">‚úï</button></div>
    <div id="detailContent" style="flex:1;"></div>
  </div>

  <div id="cartScreen" class="screen hidden">
    <div class="nav-bar">
      <button class="nav-btn" onclick="goBack()">‚Üì</button>
      <span class="nav-title">–ö–æ—Ä–∑–∏–Ω–∞</span>
      <button onclick="clearCart()" style="margin-left:auto;background:none;border:none;color:#ef4444;">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    <div id="cartList" class="container" style="padding-top:10px;"></div>
    
    <div id="cartFooter" class="container" style="margin-top:auto; padding-bottom:30px;">
      
      <div class="promo-box">
        <span style="font-size:16px;">üéüÔ∏è</span>
        <input type="text" id="promoInput" class="promo-input" placeholder="–ü–†–û–ú–û–ö–û–î" />
        <button class="promo-apply" onclick="applyPromo()">OK</button>
      </div>
      <div id="promoMessage" style="font-size:12px; color:#10b981; margin:4px 0 10px 4px; display:none;">–°–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!</div>

      <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:18px; font-weight:700;">
        <span>–ò—Ç–æ–≥–æ:</span>
        <span style="color:var(--primary)" id="cartTotalBig">0 –≥—Ä–Ω</span>
      </div>
      <button class="big-btn" onclick="openCheckout()">–û—Ñ–æ—Ä–º–∏—Ç—å ‚ûú</button>
    </div>
  </div>

  <div id="checkoutScreen" class="screen hidden">
    <div class="nav-bar"><button class="nav-btn" onclick="closeCheckout()">‚Üê</button><span class="nav-title">–î–æ—Å—Ç–∞–≤–∫–∞</span></div>
    <div class="container" style="padding-top:20px;">
      <input type="text" id="orderName" class="inp-field" placeholder="–ò–º—è" />
      <input type="tel" id="orderPhone" class="inp-field" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
      <input type="text" id="orderAddress" class="inp-field" placeholder="–ì–æ—Ä–æ–¥ –∏ –û—Ç–¥–µ–ª–µ–Ω–∏–µ –ù–ü" />
      <input type="text" id="orderComment" class="inp-field" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" />
      <button class="big-btn" onclick="submitOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑ ‚úÖ</button>
    </div>
  </div>

  <div id="storyViewer" class="hidden" onclick="closeStory()">
    <div class="story-progress"><div id="storyBar" class="story-bar"></div></div>
    <img id="storyImage" src="" class="story-full-img" />
    <div style="position:absolute; bottom:40px; width:100%; text-align:center;">
      <button class="big-btn" style="width:200px;" onclick="event.stopPropagation(); closeStory()">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>

  <div id="floatDock" class="dock" onclick="openCart()">
    <div style="padding-left:10px;">
      <div style="font-weight:800; color:#fff;" id="dockTotal">0 –≥—Ä–Ω</div>
      <div style="font-size:11px; color:#94a3b8;" id="dockCount">0 –ø–æ–∑.</div>
    </div>
    <button class="dock-btn">–ö–æ—Ä–∑–∏–Ω–∞</button>
  </div>

  <script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if(tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#020617'); tg.setBackgroundColor('#020617'); }

    // --- MOCK DATA ---
    const STORIES = [
      { id: 1, title: "–ù–æ–≤–∏–Ω–∫–∏", img: "https://i.imgur.com/8p51V9u.jpeg", full: "https://i.imgur.com/8p51V9u.jpeg" },
      { id: 2, title: "–°–∫–∏–¥–∫–∏", img: "https://i.imgur.com/Q2gG6qM.jpeg", full: "https://i.imgur.com/Q2gG6qM.jpeg" },
      { id: 3, title: "–¢–æ–ø Pods", img: "https://i.imgur.com/5lG2o1s.jpeg", full: "https://i.imgur.com/5lG2o1s.jpeg" }
    ];
    // Simple promo logic (SERVER SHOULD VALIDATE THIS IN REAL APP)
    const PROMOS = { "START": 0.1, "VAPE2025": 0.15, "TEST": 0.5 }; 

    let products = [];
    let cart = [];
    let favorites = JSON.parse(localStorage.getItem('vm_favs') || '[]');
    let activeCat = "–í—Å–µ";
    let activeDiscount = 0; // 0.1 = 10%
    let sortBy = "default";
    let filterStock = false;
    let filterFavorites = false;

    // --- INIT ---
    async function init() {
      renderStories();
      try {
        const res = await fetch('products.json');
        products = await res.json();
        renderCats();
        renderGrid();
      } catch(e) { document.getElementById('gridContainer').innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; }
    }

    // --- STORIES ---
    function renderStories() {
      const el = document.getElementById('storiesContainer');
      el.innerHTML = STORIES.map(s => `
        <div class="story-item" onclick="viewStory('${s.full}')">
          <div class="story-ring"><img src="${s.img}" class="story-img"></div>
          <div class="story-text">${s.title}</div>
        </div>
      `).join('');
    }

    let storyTimer;
    function viewStory(imgUrl) {
      document.getElementById('storyViewer').classList.remove('hidden');
      document.getElementById('storyImage').src = imgUrl;
      const bar = document.getElementById('storyBar');
      bar.style.width = '0%';
      setTimeout(() => bar.style.width = '100%', 10);
      
      clearTimeout(storyTimer);
      storyTimer = setTimeout(closeStory, 5000); // 5 sec auto close
    }
    function closeStory() {
      document.getElementById('storyViewer').classList.add('hidden');
      document.getElementById('storyBar').style.width = '0%';
      clearTimeout(storyTimer);
    }

    // --- RENDER GRID ---
    function renderCats() {
      const cats = ["–í—Å–µ", ...new Set(products.map(p => p.category))];
      document.getElementById('catsContainer').innerHTML = cats.map(c => `
        <div class="cat-chip ${c===activeCat?'active':''}" onclick="setCat('${c}')">${c}</div>
      `).join('');
    }
    function setCat(c) { activeCat = c; renderCats(); renderGrid(); }

    function toggleFilter(type) {
      if(type === 'stock') {
        filterStock = !filterStock;
        document.getElementById('filterStockIcon').textContent = filterStock ? '‚úì' : '';
        document.getElementById('filterStock').classList.toggle('active', filterStock);
      } else if(type === 'favorites') {
        filterFavorites = !filterFavorites;
        document.getElementById('filterFavoritesIcon').textContent = filterFavorites ? '‚ô•' : '‚ô°';
        document.getElementById('filterFavorites').classList.toggle('active', filterFavorites);
      }
      renderGrid();
    }

    function renderGrid() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      sortBy = document.getElementById('sortSelect').value;
      
      let list = products.filter(p => {
        // –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏ –ø–æ–∏—Å–∫
        const matchCat = activeCat==="–í—Å–µ" || p.category===activeCat;
        const matchSearch = p.name.toLowerCase().includes(q);
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–ª–∏—á–∏—é
        const hasOptions = p.options && p.options.length > 0;
        const inStock = hasOptions ? p.options.some(o=>o.inStock) : (p.inStock !== false);
        const matchStock = !filterStock || inStock;
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–º—É
        const matchFav = !filterFavorites || favorites.includes(p.id);
        
        return matchCat && matchSearch && matchStock && matchFav;
      });
      
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      if(sortBy === 'price-asc') {
        list.sort((a, b) => a.price - b.price);
      } else if(sortBy === 'price-desc') {
        list.sort((a, b) => b.price - a.price);
      } else if(sortBy === 'name-asc') {
        list.sort((a, b) => a.name.localeCompare(b.name, 'uk'));
      } else if(sortBy === 'name-desc') {
        list.sort((a, b) => b.name.localeCompare(a.name, 'uk'));
      }
      
      const el = document.getElementById('gridContainer');
      el.innerHTML = "";
      
      if(list.length === 0) {
        el.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-sec);">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
      }
      
      list.forEach((p, idx) => {
        const hasOptions = p.options && p.options.length > 0;
        const isFav = favorites.includes(p.id);
        const inStock = hasOptions ? p.options.some(o=>o.inStock) : p.inStock;
        
        let btn = !inStock ? `<button class="btn-mini" style="opacity:0.5">–ù–µ—Ç</button>` 
          : hasOptions ? `<button class="btn-mini btn-choose" onclick="openDetail(${p.id})">–í—ã–±—Ä–∞—Ç—å</button>`
          : `<button class="btn-mini btn-add" onclick="quickAdd(${p.id})">+ –ö—É–ø–∏—Ç—å</button>`;

        // Badges logic (random simulation for demo)
        const isHit = idx % 3 === 0;
        const isNew = idx % 5 === 0;

        el.innerHTML += `
          <div class="card" style="animation-delay:${idx*50}ms">
            <div class="card-image-box" onclick="openDetail(${p.id})">
              ${p.image ? `<img src="${p.image}" class="card-img" loading="lazy">` : ''}
              <div class="badges">
                ${isHit ? '<span class="badge badge-hit">–•–ò–¢</span>' : ''}
                ${isNew ? '<span class="badge badge-new">NEW</span>' : ''}
              </div>
              <button class="fav-btn ${isFav?'active':''}" onclick="toggleFav(event,${p.id})">‚ô•</button>
            </div>
            <div class="card-content">
              <div class="card-title" onclick="openDetail(${p.id})">${p.name}</div>
              <div class="card-footer">
                <div class="price">${p.price} ‚Ç¥</div>
                ${btn}
              </div>
            </div>
          </div>
        `;
      });
    }
    document.getElementById('searchInput').oninput = renderGrid;

    // --- CART & PROMO ---
    function addToCart(id, optId, qty) {
      const ex = cart.find(i => i.id===id && i.optionId===optId);
      if(ex) ex.qty += qty; else cart.push({ id, optionId: optId, qty });
      if(tg) tg.HapticFeedback.impactOccurred('light');
      updateUI();
    }
    
    function applyPromo() {
      const code = document.getElementById('promoInput').value.trim().toUpperCase();
      const msg = document.getElementById('promoMessage');
      if(PROMOS[code]) {
        activeDiscount = PROMOS[code];
        msg.style.display = 'block';
        msg.textContent = `–°—É–ø–µ—Ä! –°–∫–∏–¥–∫–∞ ${activeDiscount*100}% –ø—Ä–∏–º–µ–Ω–µ–Ω–∞`;
        msg.style.color = '#10b981';
        if(tg) tg.HapticFeedback.notificationOccurred('success');
      } else {
        activeDiscount = 0;
        msg.style.display = 'block';
        msg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';
        msg.style.color = '#ef4444';
        if(tg) tg.HapticFeedback.notificationOccurred('error');
      }
      updateUI();
    }

    function updateUI() {
      let total = 0, count = 0;
      cart.forEach(i => {
        const p = products.find(x => x.id===i.id);
        if(p) { total += p.price * i.qty; count += i.qty; }
      });
      
      // Discount calc
      const finalTotal = Math.round(total * (1 - activeDiscount));

      const dock = document.getElementById('floatDock');
      if(count>0) dock.classList.add('visible'); else dock.classList.remove('visible');
      document.getElementById('dockTotal').innerText = finalTotal + " –≥—Ä–Ω";
      document.getElementById('dockCount').innerText = count + " —à—Ç.";

      // Cart screen
      const totalHtml = activeDiscount > 0 
        ? `<span style="text-decoration:line-through;color:#94a3b8;font-size:14px;margin-right:6px;">${total}</span> ${finalTotal} –≥—Ä–Ω`
        : `${total} –≥—Ä–Ω`;
        
      document.getElementById('cartTotalBig').innerHTML = totalHtml;
      renderCartItems();
    }

    function quickAdd(id) { addToCart(id, null, 1); }
    function toggleFav(e, id) {
      e.stopPropagation();
      if(favorites.includes(id)) favorites = favorites.filter(x=>x!==id); else favorites.push(id);
      localStorage.setItem('vm_favs', JSON.stringify(favorites));
      e.target.classList.toggle('active');
    }

    // --- DETAILS ---
    let curP = null, curO = null;
    function openDetail(id) {
      curP = products.find(p => p.id===id);
      if(!curP) return;
      curO = null;
      if(curP.options && curP.options.length) {
        const av = curP.options.find(o=>o.inStock);
        if(av) curO = av.id;
      }
      renderDetail();
      document.getElementById('detailScreen').classList.remove('hidden');
    }
    
    function renderDetail() {
      const p = curP;
      let opts = '';
      if(p.options && p.options.length) {
        opts = `
        <div style="margin-bottom:12px;">
          ${p.options.map(o => `
            <div class="opt-chip ${o.id===curO?'active':''} ${!o.inStock?'disabled':''}" onclick="curO='${o.id}';renderDetail();">
              ${o.name}
            </div>`).join('')}
        </div>`;
      }
      const canBuy = (p.options && p.options.length) ? curO : (p.inStock !== false);
      
      document.getElementById('detailContent').innerHTML = `
        ${p.image ? `<img src="${p.image}" class="detail-img">` : ''}
        <div class="container">
          <h2 style="margin:10px 0;">${p.name}</h2>
          <div style="font-size:24px;font-weight:800;color:var(--primary);margin-bottom:16px;">${p.price} –≥—Ä–Ω</div>
          ${opts}
          <div style="color:#cbd5e1;font-size:14px;line-height:1.5;">${p.descriptionFull||p.descriptionShort||""}</div>
          <button class="big-btn" ${!canBuy?'disabled':''} onclick="addDetail()">
            ${canBuy?'–í –∫–æ—Ä–∑–∏–Ω—É':'–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
          </button>
        </div>
      `;
    }
    function addDetail() { addToCart(curP.id, curO, 1); goBack(); }

    // --- CART SCREEN ---
    function openCart() {
      document.getElementById('cartScreen').classList.remove('hidden');
      updateUI();
    }
    function renderCartItems() {
      const list = document.getElementById('cartList');
      list.innerHTML = "";
      cart.forEach((item, idx) => {
        const p = products.find(x => x.id===item.id);
        if(!p) return;
        let optName = "";
        if(item.optionId) { const o = p.options.find(opt=>opt.id===item.optionId); if(o) optName = o.name; }
        
        list.innerHTML += `
          <div class="cart-row">
            ${p.image?`<img src="${p.image}" class="cart-img">`:''}
            <div style="flex:1;">
               <div style="font-weight:600;">${p.name}</div>
               <div style="font-size:12px;color:#94a3b8;">${optName}</div>
               <div style="color:var(--primary);font-weight:700;">${p.price*item.qty} –≥—Ä–Ω</div>
            </div>
            <div class="qty-ctrl">
               <button class="qty-btn" onclick="modCart(${idx},-1)">-</button>
               <div class="qty-val">${item.qty}</div>
               <button class="qty-btn" onclick="modCart(${idx},1)">+</button>
            </div>
          </div>
        `;
      });
    }
    function modCart(i,d) { cart[i].qty+=d; if(cart[i].qty<=0) cart.splice(i,1); updateUI(); if(!cart.length) goBack(); }
    function clearCart() { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å?')) { cart=[]; updateUI(); goBack(); } }
    
    // --- CHECKOUT ---
    function openCheckout() { document.getElementById('checkoutScreen').classList.remove('hidden'); }
    function closeCheckout() { document.getElementById('checkoutScreen').classList.add('hidden'); }
    function submitOrder() {
      const name = document.getElementById('orderName').value;
      const phone = document.getElementById('orderPhone').value;
      if(!name || !phone) return alert('–ù—É–∂–Ω–æ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω');
      
      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
      let total = 0;
      cart.forEach(i => {
        const p = products.find(x => x.id===i.id);
        if(p) total += p.price * i.qty;
      });
      const finalTotal = Math.round(total * (1 - activeDiscount));
      
      confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –±–æ—Ç–∞ (id -> productId)
      const itemsForBot = cart.map(item => ({
        productId: item.id,
        optionId: item.optionId || null,
        qty: item.qty
      }));
      
      const payload = {
        action: "cart_checkout",
        items: itemsForBot,
        contact: { name, phone, address: document.getElementById('orderAddress').value, comment: document.getElementById('orderComment').value },
        promo: activeDiscount > 0 ? document.getElementById('promoInput').value : null,
        totalPrice: finalTotal,
        originalTotal: total
      };
      
      setTimeout(() => { if(tg) tg.sendData(JSON.stringify(payload)); }, 2000);
    }

    // --- NAV ---
    function goBack() {
      document.getElementById('detailScreen').classList.add('hidden');
      document.getElementById('cartScreen').classList.add('hidden');
    }

    init();
  </script>
</body>
</html>
