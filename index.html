<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Vape Market</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --card-border: 1px solid rgba(148, 163, 184, 0.1);
      --primary: #10b981; /* Emerald Green */
      --primary-glow: rgba(16, 185, 129, 0.4);
      --text-main: #f1f5f9;
      --text-sec: #94a3b8;
      --danger: #ef4444;
      --accent: #3b82f6;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top center, #1e293b 0%, #020617 100%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: 90px; /* Place for floating bar */
    }

    /* SCROLLBAR HIDING */
    ::-webkit-scrollbar { width: 0px; background: transparent; }

    /* LAYOUT & CONTAINERS */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }

    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo {
      font-size: 22px;
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* SEARCH & FILTERS */
    .search-bar {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      border: var(--card-border);
      display: flex;
      padding: 4px;
      margin-bottom: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .search-input {
      background: transparent;
      border: none;
      color: #fff;
      padding: 10px 12px;
      flex: 1;
      font-size: 15px;
      outline: none;
    }
    .search-input::placeholder { color: var(--text-sec); }

    .categories-wrapper {
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
    }
    .cat-chip {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 13px;
      white-space: nowrap;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.2s;
    }
    .cat-chip.active {
      background: var(--primary);
      color: #000;
      font-weight: 600;
      border-color: var(--primary);
      box-shadow: 0 0 15px var(--primary-glow);
    }

    /* PRODUCTS GRID */
    .products-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .card {
      background: var(--card-bg);
      border: var(--card-border);
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
      transition: transform 0.15s;
    }
    .card:active { transform: scale(0.98); }

    .card-img-wrap {
      width: 100%;
      padding-top: 100%; /* 1:1 Aspect Ratio */
      position: relative;
      background: #1e293b;
    }
    .card-img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    .card-info { padding: 12px; flex: 1; display: flex; flex-direction: column; }
    .card-title { font-size: 14px; font-weight: 600; line-height: 1.3; margin-bottom: 4px; flex: 1; }
    .card-meta { font-size: 11px; color: var(--text-sec); margin-bottom: 8px; }
    .card-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    .price { font-size: 15px; font-weight: 700; color: var(--primary); }
    
    .add-btn-mini {
      width: 32px; height: 32px;
      border-radius: 50%;
      background: var(--primary);
      border: none;
      color: #000;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 10px var(--primary-glow);
    }
    .add-btn-mini.disabled { background: #334155; color: #64748b; box-shadow: none; pointer-events: none; }

    /* FLOATING CART BAR */
    .floating-cart {
      position: fixed;
      bottom: 20px; left: 16px; right: 16px;
      background: rgba(16, 185, 129, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px var(--primary-glow);
      z-index: 100;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform: translateY(150%); /* Hidden by default */
    }
    .floating-cart.visible { transform: translateY(0); }
    
    .cart-info-text { font-weight: 700; font-size: 15px; display: flex; flex-direction: column; line-height: 1.1; }
    .cart-info-sub { font-size: 11px; font-weight: 500; opacity: 0.8; }
    .cart-open-btn {
      background: #000;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 99px;
      font-size: 13px;
      font-weight: 600;
    }

    /* FULLSCREEN MODALS (Product, Cart, Checkout) */
    .screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-color);
      z-index: 200;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    
    .screen-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .back-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      width: 36px; height: 36px;
      border-radius: 50%;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
    }
    .screen-title { font-size: 20px; font-weight: 700; }

    /* DETAIL VIEW */
    .detail-img { width: 100%; border-radius: 20px; margin-bottom: 16px; border: var(--card-border); }
    .detail-price { font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
    .detail-desc { color: var(--text-sec); font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
    
    .options-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .opt-chip {
      padding: 8px 16px; border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      font-size: 13px; color: var(--text-sec);
    }
    .opt-chip.active { background: var(--accent); color: #fff; border-color: transparent; }
    .opt-chip.disabled { opacity: 0.3; text-decoration: line-through; pointer-events: none; }

    .big-btn {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: none;
      background: var(--primary);
      color: #000;
      font-weight: 700;
      font-size: 16px;
      margin-top: auto;
      box-shadow: 0 4px 15px var(--primary-glow);
    }
    .big-btn:disabled { background: #334155; color: #64748b; box-shadow: none; }

    /* CART ITEMS */
    .cart-item {
      display: flex;
      gap: 12px;
      background: rgba(255,255,255,0.03);
      padding: 10px;
      border-radius: 16px;
      margin-bottom: 10px;
      align-items: center;
    }
    .cart-thumb { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; background: #334155; }
    .cart-details { flex: 1; }
    .cart-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
    .cart-var { font-size: 11px; color: var(--text-sec); margin-bottom: 4px; }
    .cart-price { color: var(--primary); font-weight: 700; font-size: 14px; }
    
    .qty-control {
      display: flex;
      align-items: center;
      background: #000;
      border-radius: 50px;
      padding: 4px;
    }
    .qty-btn {
      width: 28px; height: 28px;
      border-radius: 50%;
      border: none;
      background: #334155;
      color: #fff;
      font-weight: bold;
      display: flex; align-items: center; justify-content: center;
    }
    .qty-val { width: 30px; text-align: center; font-size: 13px; font-weight: 600; }

    /* CHECKOUT FORM */
    .input-group { margin-bottom: 16px; }
    .input-label { display: block; font-size: 12px; color: var(--text-sec); margin-bottom: 6px; margin-left: 4px; }
    .styled-input {
      width: 100%;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid #334155;
      padding: 14px;
      border-radius: 14px;
      color: #fff;
      font-size: 16px;
      outline: none;
      transition: border 0.2s;
    }
    .styled-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(16,185,129,0.1); }

    /* NOTIFICATION */
    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
      background: #fff; color: #000; padding: 10px 20px;
      border-radius: 99px; font-weight: 600; font-size: 13px;
      z-index: 999; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* EMPTY STATE */
    .empty-state { text-align: center; margin-top: 60px; color: var(--text-sec); }
    .empty-icon { font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5; }

  </style>
</head>
<body>

  <div id="toast" class="toast">–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω ‚úÖ</div>

  <div id="mainScreen" class="container fade-in">
    <div class="header">
      <div class="logo">üí® Vape Market</div>
    </div>

    <div class="search-bar">
      <span style="padding: 10px 0 10px 12px; font-size:18px;">üîç</span>
      <input type="text" id="searchInput" class="search-input" placeholder="–ù–∞–π—Ç–∏ –∂–∏–∂—É, –ø–æ–¥..." />
    </div>

    <div id="categoryContainer" class="categories-wrapper">
      </div>

    <div id="productsContainer" class="products-grid">
      </div>
  </div>

  <div id="detailScreen" class="screen hidden">
    <div class="screen-header">
      <button class="back-btn" onclick="closeDetail()">‚Üê</button>
      <div class="screen-title">–¢–æ–≤–∞—Ä</div>
    </div>
    <div id="detailContent" style="display:flex; flex-direction:column; flex:1;">
      </div>
  </div>

  <div id="cartScreen" class="screen hidden">
    <div class="screen-header">
      <button class="back-btn" onclick="closeCart()">‚Üê</button>
      <div class="screen-title">–ö–æ—Ä–∑–∏–Ω–∞ <span id="cartCountTitle" style="opacity:0.5; font-size:16px;">(0)</span></div>
      <button onclick="clearCart()" style="margin-left:auto; background:none; border:none; color:var(--danger); font-size:13px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    
    <div id="cartItemsContainer" style="flex:1;">
      </div>

    <div id="cartFooter">
      <div style="display:flex; justify-content:space-between; margin-bottom:16px; font-size:18px; font-weight:700;">
        <span>–ò—Ç–æ–≥–æ:</span>
        <span style="color:var(--primary)" id="cartTotalSum">0 –≥—Ä–Ω</span>
      </div>
      <button class="big-btn" onclick="openCheckout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </div>

  <div id="checkoutScreen" class="screen hidden">
    <div class="screen-header">
      <button class="back-btn" onclick="closeCheckout()">‚Üê</button>
      <div class="screen-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
    </div>
    
    <div style="flex:1;">
      <p style="color:var(--text-sec); font-size:13px; margin-bottom:20px;">
        –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
      </p>
      
      <div class="input-group">
        <label class="input-label">–í–∞—à–µ –∏–º—è</label>
        <input type="text" id="orderName" class="styled-input" placeholder="–ò–≤–∞–Ω" />
      </div>
      <div class="input-group">
        <label class="input-label">–¢–µ–ª–µ—Ñ–æ–Ω / Telegram</label>
        <input type="text" id="orderPhone" class="styled-input" placeholder="+380..." />
      </div>
      <div class="input-group">
        <label class="input-label">–ö—É–¥–∞ –¥–æ—Å—Ç–∞–≤–∏—Ç—å (–ì–æ—Ä–æ–¥, –û—Ç–¥–µ–ª–µ–Ω–∏–µ –ù–ü)</label>
        <input type="text" id="orderAddress" class="styled-input" placeholder="–ö–∏–µ–≤, –û—Ç–¥. ‚Ññ1" />
      </div>
      <div class="input-group">
        <label class="input-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
        <textarea id="orderComment" class="styled-input" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
      </div>
    </div>

    <button class="big-btn" id="submitOrderBtn" onclick="submitOrder()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>

  <div id="floatingCart" class="floating-cart" onclick="openCart()">
    <div class="cart-info-text">
      <span id="floatingTotal">0 –≥—Ä–Ω</span>
      <span id="floatingCount" class="cart-info-sub">0 —Ç–æ–≤–∞—Ä–æ–≤</span>
    </div>
    <button class="cart-open-btn">–í –∫–æ—Ä–∑–∏–Ω—É ‚Üí</button>
  </div>

  <script>
    // --- INIT TELEGRAM ---
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
      tg.setHeaderColor('#1e293b');
      tg.setBackgroundColor('#020617');
    }

    // --- STATE ---
    let products = [];
    let cart = []; // {id, optionId, qty}
    let activeCategory = "–í—Å–µ";
    let currentDetailProduct = null;
    let currentDetailOption = null;

    // --- ELEMENTS ---
    const els = {
      list: document.getElementById('productsContainer'),
      cats: document.getElementById('categoryContainer'),
      search: document.getElementById('searchInput'),
      floatCart: document.getElementById('floatingCart'),
      floatTotal: document.getElementById('floatingTotal'),
      floatCount: document.getElementById('floatingCount'),
      toast: document.getElementById('toast'),
      
      screens: {
        main: document.getElementById('mainScreen'),
        detail: document.getElementById('detailScreen'),
        cart: document.getElementById('cartScreen'),
        checkout: document.getElementById('checkoutScreen')
      }
    };

    // --- LOGIC ---

    async function loadData() {
      try {
        const res = await fetch("products.json");
        products = await res.json();
        renderCategories();
        renderList();
      } catch (e) {
        els.list.innerHTML = "<p style='text-align:center; margin-top:20px;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ :(</p>";
      }
    }

    // --- RENDERING LIST ---

    function renderCategories() {
      const cats = ["–í—Å–µ", ...new Set(products.map(p => p.category))];
      els.cats.innerHTML = cats.map(c => `
        <div class="cat-chip ${c === activeCategory ? 'active' : ''}" 
             onclick="setCategory('${c}')">${c}</div>
      `).join('');
    }

    function setCategory(c) {
      activeCategory = c;
      renderCategories();
      renderList();
    }

    function renderList() {
      const query = els.search.value.toLowerCase();
      const filtered = products.filter(p => 
        (activeCategory === "–í—Å–µ" || p.category === activeCategory) &&
        p.name.toLowerCase().includes(query)
      );

      els.list.innerHTML = "";
      
      if (filtered.length === 0) {
        els.list.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-sec)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üïµÔ∏è‚Äç‚ôÇÔ∏è</div>`;
        return;
      }

      filtered.forEach(p => {
        const hasOptions = p.options && p.options.length > 0;
        // Check if fully out of stock
        let inStock = true;
        if (hasOptions) {
            if (!p.options.some(o => o.inStock)) inStock = false;
        } else {
            if (p.inStock === false) inStock = false;
        }

        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = (e) => {
          // If clicked on button, don't open detail
          if (e.target.closest('.add-btn-mini')) return;
          openDetail(p.id);
        };

        const btnHtml = hasOptions 
          ? `<button class="add-btn-mini" onclick="openDetail(${p.id})">‚öôÔ∏è</button>` 
          : `<button class="add-btn-mini ${!inStock ? 'disabled' : ''}" onclick="quickAdd(${p.id})">+</button>`;

        card.innerHTML = `
          <div class="card-img-wrap">
            ${p.image ? `<img src="${p.image}" class="card-img" loading="lazy">` : ''}
            ${!inStock ? '<div style="position:absolute; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700;">–ù–ï–¢ –í –ù–ê–õ–ò–ß–ò–ò</div>' : ''}
          </div>
          <div class="card-info">
            <div class="card-title">${p.name}</div>
            <div class="card-meta">${p.category}</div>
            <div class="card-bottom">
              <div class="price">${p.price} ‚Ç¥</div>
              ${btnHtml}
            </div>
          </div>
        `;
        els.list.appendChild(card);
      });
    }

    els.search.oninput = renderList;

    // --- DETAIL VIEW ---

    function openDetail(id) {
      currentDetailProduct = products.find(p => p.id === id);
      if (!currentDetailProduct) return;
      
      // Auto-select first available option
      currentDetailOption = null;
      if (currentDetailProduct.options && currentDetailProduct.options.length) {
        const avail = currentDetailProduct.options.find(o => o.inStock);
        if (avail) currentDetailOption = avail.id;
      }

      renderDetailContent();
      showScreen('detail');
    }

    function renderDetailContent() {
      const p = currentDetailProduct;
      const container = document.getElementById('detailContent');
      
      let optionsHtml = '';
      if (p.options && p.options.length) {
        optionsHtml = `
          <div style="margin-bottom:8px; font-size:13px; color:var(--text-sec)">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:</div>
          <div class="options-grid">
            ${p.options.map(o => `
              <div class="opt-chip ${o.id === currentDetailOption ? 'active' : ''} ${!o.inStock ? 'disabled' : ''}"
                   onclick="selectDetailOption('${o.id}')">
                ${o.name}
              </div>
            `).join('')}
          </div>
        `;
      }

      const isAvailable = (p.options && p.options.length) 
        ? (currentDetailOption !== null) 
        : (p.inStock !== false);

      container.innerHTML = `
        ${p.image ? `<img src="${p.image}" class="detail-img">` : ''}
        <div class="detail-price">${p.price} –≥—Ä–Ω</div>
        <h2 style="margin:0 0 10px 0; font-size:22px;">${p.name}</h2>
        
        ${optionsHtml}
        
        <div class="detail-desc">
          ${p.descriptionFull || p.descriptionShort || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."}
        </div>

        <button class="big-btn" ${!isAvailable ? 'disabled' : ''} onclick="addToCartFromDetail()">
          ${isAvailable ? '–í –∫–æ—Ä–∑–∏–Ω—É' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
        </button>
      `;
    }

    window.selectDetailOption = (oid) => {
      currentDetailOption = oid;
      renderDetailContent();
    };

    function addToCartFromDetail() {
        if (currentDetailProduct.options && !currentDetailOption) return;
        addToCart(currentDetailProduct.id, currentDetailOption, 1);
        closeDetail();
    }

    function closeDetail() { showScreen('main'); }

    // --- CART LOGIC ---

    function quickAdd(id) {
      addToCart(id, null, 1);
    }

    function addToCart(id, optId, qty) {
      const existing = cart.find(i => i.id === id && i.optionId === optId);
      if (existing) {
        existing.qty += qty;
      } else {
        cart.push({ id, optionId: optId, qty });
      }
      updateCartUI();
      showToast();
    }

    function updateCartUI() {
      // Calc totals
      let totalQty = 0;
      let totalSum = 0;

      cart.forEach(item => {
        const p = products.find(x => x.id === item.id);
        if (p) {
            totalQty += item.qty;
            totalSum += p.price * item.qty;
        }
      });

      // Update Floating Bar
      if (totalQty > 0) {
        els.floatCart.classList.add('visible');
        els.floatTotal.textContent = `${totalSum} –≥—Ä–Ω`;
        els.floatCount.textContent = `${totalQty} —à—Ç.`;
      } else {
        els.floatCart.classList.remove('visible');
      }

      // Update Cart Screen Headers
      document.getElementById('cartCountTitle').textContent = `(${totalQty})`;
      document.getElementById('cartTotalSum').textContent = `${totalSum} –≥—Ä–Ω`;
    }

    function openCart() {
      renderCartItems();
      showScreen('cart');
    }

    function renderCartItems() {
      const container = document.getElementById('cartItemsContainer');
      container.innerHTML = '';

      if (cart.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">üõí</span>
            <p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
            <button onclick="closeCart()" class="cart-open-btn" style="background:#334155; margin-top:10px;">–í –∫–∞—Ç–∞–ª–æ–≥</button>
          </div>
        `;
        document.getElementById('cartFooter').classList.add('hidden');
        return;
      }
      document.getElementById('cartFooter').classList.remove('hidden');

      cart.forEach((item, idx) => {
        const p = products.find(x => x.id === item.id);
        if (!p) return;
        
        let optName = '';
        if (item.optionId) {
          const o = p.options.find(opt => opt.id === item.optionId);
          if (o) optName = o.name;
        }

        const el = document.createElement('div');
        el.className = 'cart-item';
        el.innerHTML = `
          ${p.image ? `<img src="${p.image}" class="cart-thumb">` : `<div class="cart-thumb"></div>`}
          <div class="cart-details">
            <div class="cart-name">${p.name}</div>
            <div class="cart-var">${optName}</div>
            <div class="cart-price">${p.price * item.qty} –≥—Ä–Ω</div>
          </div>
          <div class="qty-control">
            <button class="qty-btn" onclick="modifyCartItem(${idx}, -1)">‚àí</button>
            <div class="qty-val">${item.qty}</div>
            <button class="qty-btn" onclick="modifyCartItem(${idx}, 1)">+</button>
          </div>
        `;
        container.appendChild(el);
      });
    }

    function modifyCartItem(index, delta) {
      const item = cart[index];
      item.qty += delta;
      if (item.qty <= 0) {
        cart.splice(index, 1);
      }
      updateCartUI();
      renderCartItems();
      if (cart.length === 0) closeCart();
    }

    function clearCart() {
      if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?")) return;
      cart = [];
      updateCartUI();
      renderCartItems();
    }

    function closeCart() { showScreen('main'); }

    // --- CHECKOUT ---

    function openCheckout() {
      if(cart.length === 0) return;
      showScreen('checkout');
    }

    function closeCheckout() { showScreen('cart'); }

    function submitOrder() {
      const name = document.getElementById('orderName').value.trim();
      const phone = document.getElementById('orderPhone').value.trim();
      const address = document.getElementById('orderAddress').value.trim();
      const comment = document.getElementById('orderComment').value.trim();

      if (!name || !phone) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ò–º—è –∏ –¢–µ–ª–µ—Ñ–æ–Ω.");
        return;
      }

      // Payload structure
      const payload = {
        action: "cart_checkout",
        items: cart.map(i => ({
          productId: i.id,
          optionId: i.optionId,
          qty: i.qty
        })),
        contact: { name, phone, address, comment, preferred: "telegram" }
      };

      if (tg && tg.sendData) {
        tg.sendData(JSON.stringify(payload));
      } else {
        alert("–ó–∞–∫–∞–∑ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω! (–¢–µ—Å—Ç)");
        console.log(payload);
      }
    }

    // --- UTILS ---

    function showScreen(name) {
      Object.values(els.screens).forEach(el => el.classList.add('hidden'));
      els.screens[name].classList.remove('hidden');
      window.scrollTo(0,0);
    }

    function showToast() {
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), 2000);
    }

    // Init
    loadData();

  </script>
</body>
</html>
