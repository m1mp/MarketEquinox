<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Vape Market</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* === –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò === */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: radial-gradient(circle at top, #020617 0, #0f172a 100%);
      color: #e5e7eb;
      padding: 16px;
      padding-bottom: 100px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –ª–∏–ø–∫—É—é –∫–Ω–æ–ø–∫—É */
      min-height: 100vh;
    }

    .app { max-width: 800px; margin: 0 auto; }
    .hidden { display: none !important; }

    /* === HEADER === */
    .header { margin-bottom: 16px; }
    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 99px;
      background: rgba(148, 163, 184, 0.15);
      color: #94a3b8;
      border: 1px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 8px;
    }
    .header-title { font-size: 26px; font-weight: 800; line-height: 1.1; margin-bottom: 4px; }
    .header-sub { font-size: 13px; color: #9ca3af; }

    /* === UI –≠–õ–ï–ú–ï–ù–¢–´ === */
    .btn, .btn-secondary {
      border-radius: 14px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: none;
      color: white;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4);
    }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.6; filter: grayscale(1); cursor: not-allowed; }

    .btn-secondary {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.5);
      color: #e2e8f0;
    }
    .btn-secondary:active { background: rgba(51, 65, 85, 0.8); }

    .input-field {
      width: 100%;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.5);
      color: #fff;
      padding: 12px;
      border-radius: 12px;
      outline: none;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .input-field:focus { border-color: #22c55e; }

    /* === TOAST –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø === */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(34, 197, 94, 0.95);
      color: white;
      padding: 10px 20px;
      border-radius: 99px;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 99999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      margin-top: -20px;
    }
    .toast.visible { opacity: 1; pointer-events: auto; margin-top: 0; }

    /* === –ü–ê–ù–ï–õ–¨ –§–ò–õ–¨–¢–†–û–í === */
    .top-bar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      margin: 0 -16px 16px;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
    }
    .categories { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
    .categories::-webkit-scrollbar { display: none; }
    .cat-btn {
      flex-shrink: 0;
      border-radius: 99px;
      padding: 6px 14px;
      font-size: 13px;
      border: 1px solid rgba(71, 85, 105, 0.5);
      background: rgba(30, 41, 59, 0.5);
      color: #cbd5e1;
      transition: all 0.2s;
    }
    .cat-btn.active {
      background: #22c55e;
      color: #fff;
      border-color: #22c55e;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
    }

    /* === –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í === */
    .products { display: grid; gap: 12px; }
    .card {
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 18px;
      padding: 12px;
      display: flex;
      gap: 12px;
      transition: transform 0.1s;
    }
    .card:active { transform: scale(0.99); }
    
    .card-img {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      background: #1e293b;
    }
    .card-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .card-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; color: #f1f5f9; }
    .card-price { font-weight: 800; color: #4ade80; font-size: 16px; }
    
    .card-actions { display: flex; gap: 8px; margin-top: 8px; }
    .card-btn-add { flex: 1; font-size: 12px; padding: 8px; }

    /* === –ù–ò–ñ–ù–Ø–Ø –ü–õ–ê–í–ê–Æ–©–ê–Ø –ü–ê–ù–ï–õ–¨ === */
    .bottom-bar {
      position: fixed;
      bottom: 20px;
      left: 16px; 
      right: 16px;
      max-width: 768px;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(12px);
      padding: 12px;
      border-radius: 20px;
      border: 1px solid rgba(51, 65, 85, 0.8);
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transform: translateY(150%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .bottom-bar.visible { transform: translateY(0); }
    .cart-info { font-size: 13px; color: #94a3b8; }
    .cart-total { font-size: 16px; font-weight: 700; color: #fff; }

    /* === –ú–û–î–ê–õ–ö–ò (–û–§–û–†–ú–õ–ï–ù–ò–ï, 18+, –î–ï–¢–ê–õ–ò) === */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(2, 6, 23, 0.95);
      z-index: 1000;
      display: flex; align-items: center; justify-content: center;
      padding: 16px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.2s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    
    .modal-card {
      width: 100%; max-width: 400px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      max-height: 90vh;
      overflow-y: auto;
    }

    .form-group { display: flex; flex-direction: column; gap: 12px; margin-top: 16px; }
    .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 8px; text-align: center; }
    .modal-desc { font-size: 13px; color: #94a3b8; text-align: center; line-height: 1.4; }

    /* === –°–¢–†–ê–ù–ò–¶–ê –ö–û–†–ó–ò–ù–´ === */
    .cart-item {
      display: flex; gap: 12px; padding: 12px;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 14px;
      margin-bottom: 8px;
      align-items: center;
    }
    .qty-ctrl {
      display: flex; align-items: center; gap: 10px;
      background: rgba(15, 23, 42, 0.6);
      padding: 4px 8px; border-radius: 8px;
    }
    .qty-btn { color: #fff; background: none; border: none; font-size: 16px; padding: 0 4px; cursor: pointer;}
  </style>
</head>
<body>

  <div id="toast" class="toast">–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!</div>

  <div id="ageGate" class="modal-overlay">
    <div class="modal-card" style="text-align: center;">
      <div style="font-size: 40px; margin-bottom: 10px;">üîû</div>
      <div class="modal-title">–¢–µ–±–µ –µ—Å—Ç—å 18 –ª–µ—Ç?</div>
      <div class="modal-desc">–ü—Ä–æ–¥—É–∫—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∏–∫–æ—Ç–∏–Ω –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö.</div>
      <div class="form-group">
        <button id="btnOver18" class="btn">–î–∞, –º–Ω–µ –µ—Å—Ç—å 18</button>
        <button id="btnUnder18" class="btn-secondary">–ù–µ—Ç, –ø–æ–∫–∏–Ω—É—Ç—å —Å–∞–π—Ç</button>
      </div>
    </div>
  </div>

  <div id="checkoutModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
      <div class="modal-desc">–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ù–æ–≤–æ–π –ü–æ—á—Ç–æ–π</div>
      <form id="checkoutForm" class="form-group">
        <input class="input-field" type="text" id="orderName" placeholder="–ò–º—è" required />
        <input class="input-field" type="text" id="orderSurname" placeholder="–§–∞–º–∏–ª–∏—è" required />
        <input class="input-field" type="tel" id="orderPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (0XX...)" required />
        <input class="input-field" type="text" id="orderCity" placeholder="–ì–æ—Ä–æ–¥" required />
        <input class="input-field" type="number" id="orderNP" placeholder="–û—Ç–¥–µ–ª–µ–Ω–∏–µ –ù–ü ‚Ññ" required />
        
        <button type="submit" class="btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button type="button" id="closeCheckoutBtn" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
      </form>
    </div>
  </div>

  <div class="app">
    
    <div class="header" id="mainHeader">
      <div class="header-badge">üî• Vape Market WebApp</div>
      <div class="header-title">–ö–∞—Ç–∞–ª–æ–≥</div>
      <div class="header-sub">–õ—É—á—à–∏–µ –¥–µ–≤–∞–π—Å—ã –∏ –∂–∏–¥–∫–æ—Å—Ç–∏</div>
    </div>

    <div id="listView">
      <div class="top-bar">
        <div id="categoryBar" class="categories"></div>
        <div style="margin-top: 8px; display: flex; gap: 8px;">
          <input id="searchInput" class="input-field" style="padding: 8px 12px; font-size:13px;" placeholder="–ü–æ–∏—Å–∫..." />
        </div>
      </div>
      
      <div id="products" class="products"></div>
    </div>

    <div id="cartView" class="hidden">
      <button id="backToShopBtn" class="btn-secondary" style="margin-bottom:12px;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥</button>
      <h2 style="font-size: 22px; font-weight:800; margin-bottom:12px;">–¢–≤–æ—è –∫–æ—Ä–∑–∏–Ω–∞</h2>
      <div id="cartItemsList"></div>
      <div id="cartEmptyMsg" class="hidden" style="color:#64748b; text-align:center; padding: 20px;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
      <div style="margin-top: 20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-weight:700; font-size:18px;">
          <span>–ò—Ç–æ–≥–æ:</span>
          <span id="cartViewTotal" style="color:#4ade80;">0 –≥—Ä–Ω</span>
        </div>
        <button id="btnCheckoutCart" class="btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button id="btnClearCart" class="btn-secondary" style="margin-top:8px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <div id="bottomBar" class="bottom-bar">
      <div>
        <div class="cart-total" id="stickyTotal">0 –≥—Ä–Ω</div>
        <div class="cart-info" id="stickyCount">0 —Ç–æ–≤–∞—Ä–æ–≤</div>
      </div>
      <button id="openCartBtn" class="btn" style="width: auto; padding: 8px 20px;">
        –í –∫–æ—Ä–∑–∏–Ω—É ‚Üí
      </button>
    </div>

  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
        tg.ready();
        tg.expand();
    }

    // === –°–û–°–¢–û–Ø–ù–ò–ï ===
    let products = [];
    let cart = [];
    let activeCategory = "–í—Å–µ";
    let pendingOrder = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã

    // === –≠–õ–ï–ú–ï–ù–¢–´ DOM ===
    const els = {
      products: document.getElementById("products"),
      cats: document.getElementById("categoryBar"),
      search: document.getElementById("searchInput"),
      bottomBar: document.getElementById("bottomBar"),
      stickyTotal: document.getElementById("stickyTotal"),
      stickyCount: document.getElementById("stickyCount"),
      listView: document.getElementById("listView"),
      cartView: document.getElementById("cartView"),
      cartItems: document.getElementById("cartItemsList"),
      cartTotal: document.getElementById("cartViewTotal"),
      header: document.getElementById("mainHeader"),
      checkoutModal: document.getElementById("checkoutModal"),
      checkoutForm: document.getElementById("checkoutForm"),
      toast: document.getElementById("toast"),
      ageGate: document.getElementById("ageGate")
    };

    // === –§–£–ù–ö–¶–ò–ò –•–†–ê–ù–ò–õ–ò–©–ê ===
    function loadCart() {
      try {
        const stored = localStorage.getItem("vm_cart");
        if (stored) cart = JSON.parse(stored);
      } catch(e) { console.error(e); }
    }
    function saveCart() {
      localStorage.setItem("vm_cart", JSON.stringify(cart));
      updateUI();
    }

    // === TOAST ===
    function showToast(msg) {
      els.toast.textContent = msg;
      els.toast.classList.add("visible");
      setTimeout(() => els.toast.classList.remove("visible"), 2000);
    }

    // === –†–ï–ù–î–ï–† –ö–ê–¢–ï–ì–û–†–ò–ô ===
    function renderCategories() {
      const cats = ["–í—Å–µ", ...new Set(products.map(p => p.category))];
      els.cats.innerHTML = cats.map(cat => `
        <button class="cat-btn ${cat === activeCategory ? 'active' : ''}" 
          onclick="setCategory('${cat}')">${cat}</button>
      `).join("");
    }
    window.setCategory = (cat) => {
      activeCategory = cat;
      renderCategories();
      renderProducts();
    };

    // === –†–ï–ù–î–ï–† –¢–û–í–ê–†–û–í ===
    function renderProducts() {
      const q = els.search.value.toLowerCase();
      const filtered = products.filter(p => {
        return (activeCategory === "–í—Å–µ" || p.category === activeCategory) &&
               p.name.toLowerCase().includes(q);
      });

      els.products.innerHTML = filtered.map(p => {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É, –µ—Å–ª–∏ –Ω–µ—Ç - –∑–∞–≥–ª—É—à–∫–∞
        const img = p.image || 'https://via.placeholder.com/80x80/0f172a/475569?text=No+Img';
        // –ï—Å—Ç—å –ª–∏ –æ–ø—Ü–∏–∏?
        const hasOpt = p.options && p.options.length > 0;
        const priceDisplay = p.price + (hasOpt ? " –≥—Ä–Ω" : " –≥—Ä–Ω");
        
        return `
        <div class="card">
          <img src="${img}" class="card-img" alt="">
          <div class="card-info">
            <div>
              <div class="card-title">${p.name}</div>
              <div style="font-size:12px; color:#64748b;">${p.category}</div>
            </div>
            <div class="card-price">${priceDisplay}</div>
            <div class="card-actions">
              ${hasOpt 
                ? `<button class="btn-secondary card-btn-add" onclick="showOptions(${p.id})">–í—ã–±—Ä–∞—Ç—å</button>`
                : `<button class="btn card-btn-add" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>`
              }
            </div>
          </div>
        </div>
        `;
      }).join("");
    }

    // === –ö–û–†–ó–ò–ù–ê –õ–û–ì–ò–ö–ê ===
    window.addToCart = (id, optId = null) => {
      const p = products.find(x => x.id === id);
      const existing = cart.find(x => x.id === id && x.optionId === optId);
      
      if (existing) existing.qty++;
      else cart.push({ id, optionId: optId, qty: 1 });
      
      saveCart();
      showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É!");
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
      if (navigator.vibrate) navigator.vibrate(50);
    };

    window.showOptions = (id) => {
      const p = products.find(x => x.id === id);
      const opts = p.options.map(o => `${o.name} (${o.inStock ? '–ï—Å—Ç—å' : '–ù–µ—Ç'})`).join('\n');
      // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤—É—é –º–æ–¥–∞–ª–∫—É)
      // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –æ–ø—Ü–∏—é
      const avail = p.options.find(o => o.inStock);
      if(avail) addToCart(id, avail.id);
      else alert("–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏");
    }

    function updateUI() {
      const totalQty = cart.reduce((sum, i) => sum + i.qty, 0);
      let totalPrice = 0;
      
      cart.forEach(item => {
        const p = products.find(x => x.id === item.id);
        if(p) totalPrice += p.price * item.qty;
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º Sticky Bar
      if (totalQty > 0) {
        els.bottomBar.classList.add("visible");
        els.stickyTotal.textContent = totalPrice + " –≥—Ä–Ω";
        els.stickyCount.textContent = totalQty + " —à—Ç.";
      } else {
        els.bottomBar.classList.remove("visible");
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º Total –≤ –∫–æ—Ä–∑–∏–Ω–µ
      els.cartTotal.textContent = totalPrice + " –≥—Ä–Ω";
    }

    // === –û–¢–†–ò–°–û–í–ö–ê –°–¢–†–ê–ù–ò–¶–´ –ö–û–†–ó–ò–ù–´ ===
    function renderCartPage() {
      els.cartItems.innerHTML = "";
      if (cart.length === 0) {
        document.getElementById("cartEmptyMsg").classList.remove("hidden");
        return;
      }
      document.getElementById("cartEmptyMsg").classList.add("hidden");

      cart.forEach((item, idx) => {
        const p = products.find(x => x.id === item.id);
        if (!p) return;
        
        let name = p.name;
        if (item.optionId) {
            const opt = p.options?.find(o => o.id == item.optionId);
            if (opt) name += ` (${opt.name})`;
        }

        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <div style="flex:1;">
            <div style="font-weight:600; font-size:14px; color:#f1f5f9;">${name}</div>
            <div style="font-size:13px; color:#4ade80;">${p.price * item.qty} –≥—Ä–Ω</div>
          </div>
          <div class="qty-ctrl">
            <button class="qty-btn" onclick="changeQty(${idx}, -1)">‚àí</button>
            <span style="font-size:14px; font-weight:600; min-width:16px; text-align:center;">${item.qty}</span>
            <button class="qty-btn" onclick="changeQty(${idx}, 1)">+</button>
          </div>
        `;
        els.cartItems.appendChild(div);
      });
    }

    window.changeQty = (idx, delta) => {
      cart[idx].qty += delta;
      if (cart[idx].qty <= 0) cart.splice(idx, 1);
      saveCart();
      renderCartPage();
    };

    // === –ù–ê–í–ò–ì–ê–¶–ò–Ø ===
    document.getElementById("openCartBtn").onclick = () => {
      els.listView.classList.add("hidden");
      els.bottomBar.classList.remove("visible"); // –°–∫—Ä—ã—Ç—å –±–∞—Ä –≤ —Å–∞–º–æ–π –∫–æ—Ä–∑–∏–Ω–µ
      els.header.classList.add("hidden");
      els.cartView.classList.remove("hidden");
      renderCartPage();
    };

    document.getElementById("backToShopBtn").onclick = () => {
      els.cartView.classList.add("hidden");
      els.listView.classList.remove("hidden");
      els.header.classList.remove("hidden");
      updateUI(); // –ü–æ–∫–∞–∑–∞—Ç—å –±–∞—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    };

    document.getElementById("btnClearCart").onclick = () => {
      if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?")) {
        cart = [];
        saveCart();
        renderCartPage();
      }
    };

    // === –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê (–ú–û–î–ê–õ–ö–ê) ===
    document.getElementById("btnCheckoutCart").onclick = () => {
      if(cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
      
      // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–≤–∞—Ä—ã
      const itemsPayload = cart.map(i => ({ productId: i.id, optionId: i.optionId, qty: i.qty }));
      pendingOrder = { action: "cart_checkout", items: itemsPayload };
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      els.checkoutModal.classList.add("open");
    };

    document.getElementById("closeCheckoutBtn").onclick = () => {
      els.checkoutModal.classList.remove("open");
    };

    els.checkoutForm.onsubmit = (e) => {
      e.preventDefault();
      
      const contact = {
        name: document.getElementById("orderName").value,
        surname: document.getElementById("orderSurname").value,
        phone: document.getElementById("orderPhone").value,
        city: document.getElementById("orderCity").value,
        np: document.getElementById("orderNP").value
      };

      const payload = { ...pendingOrder, contact };
      
      // –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç—É
      if (tg && tg.sendData) {
        tg.sendData(JSON.stringify(payload));
      } else {
        console.log("SENDING:", payload);
        alert("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã (–¢–µ—Å—Ç)");
        els.checkoutModal.classList.remove("open");
        cart = []; // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞
        saveCart();
        location.reload();
      }
    };

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    els.search.addEventListener("input", renderProducts);

    // Age Gate
    if(!localStorage.getItem("age_confirmed")) {
      els.ageGate.classList.add("open");
    }
    document.getElementById("btnOver18").onclick = () => {
      localStorage.setItem("age_confirmed", "true");
      els.ageGate.classList.remove("open");
    };
    document.getElementById("btnUnder18").onclick = () => {
      if(tg) tg.close();
      else document.body.innerHTML = "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω";
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞
    async function init() {
      try {
        const res = await fetch("products.json");
        products = await res.json();
      } catch(e) {
        console.error(e);
        // –§–æ–ª–±—ç–∫ –¥–ª—è —Ç–µ—Å—Ç–∞, –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞
        products = [
          {id:1, name:"ElfBar 1500", price:350, category:"–û–¥–Ω–æ—Ä–∞–∑–∫–∏", image:""},
          {id:2, name:"–ñ–∏–¥–∫–æ—Å—Ç—å Chaser", price:250, category:"–ñ–∏–¥–∫–æ—Å—Ç–∏", options:[{id:1,name:"30mg",inStock:true}]},
        ];
      }
      loadCart();
      renderCategories();
      renderProducts();
      updateUI();
    }
    
    init();

  </script>
</body>
</html>
